/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.grid._FocusManager"],["require","dojox.grid.util"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.grid._FocusManager"]){_4._hasResource["dojox.grid._FocusManager"]=true;_4.provide("dojox.grid._FocusManager");_4.require("dojox.grid.util");_4.declare("dojox.grid._FocusManager",null,{constructor:function(_7){this.grid=_7;this.cell=null;this.rowIndex=-1;this._connects=[];this.headerMenu=this.grid.headerMenu;this._connects.push(_4.connect(this.grid.domNode,"onfocus",this,"doFocus"));this._connects.push(_4.connect(this.grid.domNode,"onblur",this,"doBlur"));this._connects.push(_4.connect(this.grid.domNode,"oncontextmenu",this,"doContextMenu"));this._connects.push(_4.connect(this.grid.lastFocusNode,"onfocus",this,"doLastNodeFocus"));this._connects.push(_4.connect(this.grid.lastFocusNode,"onblur",this,"doLastNodeBlur"));this._connects.push(_4.connect(this.grid,"_onFetchComplete",this,"_delayedCellFocus"));this._connects.push(_4.connect(this.grid,"postrender",this,"_delayedHeaderFocus"));},destroy:function(){_4.forEach(this._connects,_4.disconnect);delete this.grid;delete this.cell;},_colHeadNode:null,_colHeadFocusIdx:null,_contextMenuBindNode:null,tabbingOut:false,focusClass:"dojoxGridCellFocus",focusView:null,initFocusView:function(){this.focusView=this.grid.views.getFirstScrollingView()||this.focusView;this._initColumnHeaders();},isFocusCell:function(_8,_9){return (this.cell==_8)&&(this.rowIndex==_9);},isLastFocusCell:function(){if(this.cell){return (this.rowIndex==this.grid.rowCount-1)&&(this.cell.index==this.grid.layout.cellCount-1);}return false;},isFirstFocusCell:function(){if(this.cell){return (this.rowIndex===0)&&(this.cell.index===0);}return false;},isNoFocusCell:function(){return (this.rowIndex<0)||!this.cell;},isNavHeader:function(){return (!!this._colHeadNode);},getHeaderIndex:function(){if(this._colHeadNode){return _4.indexOf(this._findHeaderCells(),this._colHeadNode);}else{return -1;}},_focusifyCellNode:function(_a){var n=this.cell&&this.cell.getNode(this.rowIndex);if(n){_4.toggleClass(n,this.focusClass,_a);if(_a){var sl=this.scrollIntoView();try{if(!this.grid.edit.isEditing()){_6.grid.util.fire(n,"focus");if(sl){this.cell.view.scrollboxNode.scrollLeft=sl;}}}catch(e){}}}},_delayedCellFocus:function(){if(this.isNavHeader()||!this.grid._focused){return;}var n=this.cell&&this.cell.getNode(this.rowIndex);if(n){try{if(!this.grid.edit.isEditing()){_4.toggleClass(n,this.focusClass,true);this.blurHeader();_6.grid.util.fire(n,"focus");}}catch(e){}}},_delayedHeaderFocus:function(){if(this.isNavHeader()){this.focusHeader();this.grid.domNode.focus();}},_initColumnHeaders:function(){var _b=this._findHeaderCells();for(var i=0;i<_b.length;i++){this._connects.push(_4.connect(_b[i],"onfocus",this,"doColHeaderFocus"));this._connects.push(_4.connect(_b[i],"onblur",this,"doColHeaderBlur"));}},_findHeaderCells:function(){var _c=_4.query("th",this.grid.viewsHeaderNode);var _d=[];for(var i=0;i<_c.length;i++){var _e=_c[i];var _f=_4.hasAttr(_e,"tabIndex");var _10=_4.attr(_e,"tabIndex");if(_f&&_10<0){_d.push(_e);}}return _d;},_setActiveColHeader:function(_11,_12,_13){_4.attr(this.grid.domNode,"aria-activedescendant",_11.id);if(_13!=null&&_13>=0&&_13!=_12){_4.toggleClass(this._findHeaderCells()[_13],this.focusClass,false);}_4.toggleClass(_11,this.focusClass,true);this._colHeadNode=_11;this._colHeadFocusIdx=_12;this._scrollHeader(this._colHeadFocusIdx);},scrollIntoView:function(){var _14=(this.cell?this._scrollInfo(this.cell):null);if(!_14||!_14.s){return null;}var rt=this.grid.scroller.findScrollTop(this.rowIndex);if(_14.n&&_14.sr){if(_14.n.offsetLeft+_14.n.offsetWidth>_14.sr.l+_14.sr.w){_14.s.scrollLeft=_14.n.offsetLeft+_14.n.offsetWidth-_14.sr.w;}else{if(_14.n.offsetLeft<_14.sr.l){_14.s.scrollLeft=_14.n.offsetLeft;}}}if(_14.r&&_14.sr){if(rt+_14.r.offsetHeight>_14.sr.t+_14.sr.h){this.grid.setScrollTop(rt+_14.r.offsetHeight-_14.sr.h);}else{if(rt<_14.sr.t){this.grid.setScrollTop(rt);}}}return _14.s.scrollLeft;},_scrollInfo:function(_15,_16){if(_15){var cl=_15,sbn=cl.view.scrollboxNode,_17={w:sbn.clientWidth,l:sbn.scrollLeft,t:sbn.scrollTop,h:sbn.clientHeight},rn=cl.view.getRowNode(this.rowIndex);return {c:cl,s:sbn,sr:_17,n:(_16?_16:_15.getNode(this.rowIndex)),r:rn};}return null;},_scrollHeader:function(_18){var _19=null;if(this._colHeadNode){var _1a=this.grid.getCell(_18);_19=this._scrollInfo(_1a,_1a.getNode(0));}if(_19&&_19.s&&_19.sr&&_19.n){var _1b=_19.sr.l+_19.sr.w;if(_19.n.offsetLeft+_19.n.offsetWidth>_1b){_19.s.scrollLeft=_19.n.offsetLeft+_19.n.offsetWidth-_19.sr.w;}else{if(_19.n.offsetLeft<_19.sr.l){_19.s.scrollLeft=_19.n.offsetLeft;}else{if(_4.isIE<=7&&_1a&&_1a.view.headerNode){_1a.view.headerNode.scrollLeft=_19.s.scrollLeft;}}}}},_isHeaderHidden:function(){var _1c=this.focusView;if(!_1c){for(var i=0,_1d;(_1d=this.grid.views.views[i]);i++){if(_1d.headerNode){_1c=_1d;break;}}}return (_1c&&_4.getComputedStyle(_1c.headerNode).display=="none");},colSizeAdjust:function(e,_1e,_1f){var _20=this._findHeaderCells();var _21=this.focusView;if(!_21){for(var i=0,_22;(_22=this.grid.views.views[i]);i++){if(_22.header.tableMap.map){_21=_22;break;}}}var _23=_20[_1e];if(!_21||(_1e==_20.length-1&&_1e===0)){return;}_21.content.baseDecorateEvent(e);e.cellNode=_23;e.cellIndex=_21.content.getCellNodeIndex(e.cellNode);e.cell=(e.cellIndex>=0?this.grid.getCell(e.cellIndex):null);if(_21.header.canResize(e)){var _24={l:_1f};var _25=_21.header.colResizeSetup(e,false);_21.header.doResizeColumn(_25,null,_24);_21.update();}},styleRow:function(_26){return;},setFocusIndex:function(_27,_28){this.setFocusCell(this.grid.getCell(_28),_27);},setFocusCell:function(_29,_2a){if(_29&&!this.isFocusCell(_29,_2a)){this.tabbingOut=false;if(this._colHeadNode){this.blurHeader();}this._colHeadNode=this._colHeadFocusIdx=null;this.focusGridView();this._focusifyCellNode(false);this.cell=_29;this.rowIndex=_2a;this._focusifyCellNode(true);}if(_4.isOpera){setTimeout(_4.hitch(this.grid,"onCellFocus",this.cell,this.rowIndex),1);}else{this.grid.onCellFocus(this.cell,this.rowIndex);}},next:function(){if(this.cell){var row=this.rowIndex,col=this.cell.index+1,cc=this.grid.layout.cellCount-1,rc=this.grid.rowCount-1;if(col>cc){col=0;row++;}if(row>rc){col=cc;row=rc;}if(this.grid.edit.isEditing()){var _2b=this.grid.getCell(col);if(!this.isLastFocusCell()&&!_2b.editable){this.cell=_2b;this.rowIndex=row;this.next();return;}}this.setFocusIndex(row,col);}},previous:function(){if(this.cell){var row=(this.rowIndex||0),col=(this.cell.index||0)-1;if(col<0){col=this.grid.layout.cellCount-1;row--;}if(row<0){row=0;col=0;}if(this.grid.edit.isEditing()){var _2c=this.grid.getCell(col);if(!this.isFirstFocusCell()&&!_2c.editable){this.cell=_2c;this.rowIndex=row;this.previous();return;}}this.setFocusIndex(row,col);}},move:function(_2d,_2e){var _2f=_2e<0?-1:1;if(this.isNavHeader()){var _30=this._findHeaderCells();var _31=currentIdx=_4.indexOf(_30,this._colHeadNode);currentIdx+=_2e;while(currentIdx>=0&&currentIdx<_30.length&&_30[currentIdx].style.display=="none"){currentIdx+=_2f;}if((currentIdx>=0)&&(currentIdx<_30.length)){this._setActiveColHeader(_30[currentIdx],currentIdx,_31);}}else{if(this.cell){var sc=this.grid.scroller,r=this.rowIndex,rc=this.grid.rowCount-1,row=Math.min(rc,Math.max(0,r+_2d));if(_2d){if(_2d>0){if(row>sc.getLastPageRow(sc.page)){this.grid.setScrollTop(this.grid.scrollTop+sc.findScrollTop(row)-sc.findScrollTop(r));}}else{if(_2d<0){if(row<=sc.getPageRow(sc.page)){this.grid.setScrollTop(this.grid.scrollTop-sc.findScrollTop(r)-sc.findScrollTop(row));}}}}var cc=this.grid.layout.cellCount-1,i=this.cell.index,col=Math.min(cc,Math.max(0,i+_2e));var _32=this.grid.getCell(col);while(col>=0&&col<cc&&_32&&_32.hidden===true){col+=_2f;_32=this.grid.getCell(col);}if(!_32||_32.hidden===true){col=i;}this.setFocusIndex(row,col);if(_2d){this.grid.updateRow(r);}}}},previousKey:function(e){if(this.grid.edit.isEditing()){_4.stopEvent(e);this.previous();}else{if(!this.isNavHeader()&&!this._isHeaderHidden()){this.grid.domNode.focus();_4.stopEvent(e);}else{this.tabOut(this.grid.domNode);if(this._colHeadFocusIdx!=null){_4.toggleClass(this._findHeaderCells()[this._colHeadFocusIdx],this.focusClass,false);this._colHeadFocusIdx=null;}this._focusifyCellNode(false);}}},nextKey:function(e){var _33=(this.grid.rowCount===0);if(e.target===this.grid.domNode&&this._colHeadFocusIdx==null){this.focusHeader();_4.stopEvent(e);}else{if(this.isNavHeader()){this.blurHeader();if(!this.findAndFocusGridCell()){this.tabOut(this.grid.lastFocusNode);}this._colHeadNode=this._colHeadFocusIdx=null;}else{if(this.grid.edit.isEditing()){_4.stopEvent(e);this.next();}else{this.tabOut(this.grid.lastFocusNode);}}}},tabOut:function(_34){this.tabbingOut=true;_34.focus();},focusGridView:function(){_6.grid.util.fire(this.focusView,"focus");},focusGrid:function(_35){this.focusGridView();this._focusifyCellNode(true);},findAndFocusGridCell:function(){var _36=true;var _37=(this.grid.rowCount===0);if(this.isNoFocusCell()&&!_37){var _38=0;var _39=this.grid.getCell(_38);if(_39.hidden){_38=this.isNavHeader()?this._colHeadFocusIdx:0;}this.setFocusIndex(0,_38);}else{if(this.cell&&!_37){if(this.focusView&&!this.focusView.rowNodes[this.rowIndex]){this.grid.scrollToRow(this.rowIndex);}this.focusGrid();}else{_36=false;}}this._colHeadNode=this._colHeadFocusIdx=null;return _36;},focusHeader:function(){var _3a=this._findHeaderCells();var _3b=this._colHeadFocusIdx;if(this._isHeaderHidden()){this.findAndFocusGridCell();}else{if(!this._colHeadFocusIdx){if(this.isNoFocusCell()){this._colHeadFocusIdx=0;}else{this._colHeadFocusIdx=this.cell.index;}}}this._colHeadNode=_3a[this._colHeadFocusIdx];while(this._colHeadNode&&this._colHeadFocusIdx>=0&&this._colHeadFocusIdx<_3a.length&&this._colHeadNode.style.display=="none"){this._colHeadFocusIdx++;this._colHeadNode=_3a[this._colHeadFocusIdx];}if(this._colHeadNode&&this._colHeadNode.style.display!="none"){if(this.headerMenu&&this._contextMenuBindNode!=this.grid.domNode){this.headerMenu.unBindDomNode(this.grid.viewsHeaderNode);this.headerMenu.bindDomNode(this.grid.domNode);this._contextMenuBindNode=this.grid.domNode;}this._setActiveColHeader(this._colHeadNode,this._colHeadFocusIdx,_3b);this._scrollHeader(this._colHeadFocusIdx);this._focusifyCellNode(false);}else{this.findAndFocusGridCell();}},blurHeader:function(){_4.removeClass(this._colHeadNode,this.focusClass);_4.removeAttr(this.grid.domNode,"aria-activedescendant");if(this.headerMenu&&this._contextMenuBindNode==this.grid.domNode){var _3c=this.grid.viewsHeaderNode;this.headerMenu.unBindDomNode(this.grid.domNode);this.headerMenu.bindDomNode(_3c);this._contextMenuBindNode=_3c;}},doFocus:function(e){if(e&&e.target!=e.currentTarget){_4.stopEvent(e);return;}if(!this.tabbingOut){this.focusHeader();}this.tabbingOut=false;_4.stopEvent(e);},doBlur:function(e){_4.stopEvent(e);},doContextMenu:function(e){if(!this.headerMenu){_4.stopEvent(e);}},doLastNodeFocus:function(e){if(this.tabbingOut){this._focusifyCellNode(false);}else{if(this.grid.rowCount>0){if(this.isNoFocusCell()){this.setFocusIndex(0,0);}this._focusifyCellNode(true);}else{this.focusHeader();}}this.tabbingOut=false;_4.stopEvent(e);},doLastNodeBlur:function(e){_4.stopEvent(e);},doColHeaderFocus:function(e){this._setActiveColHeader(e.target,_4.attr(e.target,"idx"),this._colHeadFocusIdx);this._scrollHeader(this.getHeaderIndex());_4.stopEvent(e);},doColHeaderBlur:function(e){_4.toggleClass(e.target,this.focusClass,false);}});}}};});