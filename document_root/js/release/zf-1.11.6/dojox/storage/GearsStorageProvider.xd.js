/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.storage.GearsStorageProvider"],["require","dojo.gears"],["require","dojox.storage.Provider"],["require","dojox.storage.manager"],["require","dojox.sql"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.storage.GearsStorageProvider"]){_4._hasResource["dojox.storage.GearsStorageProvider"]=true;_4.provide("dojox.storage.GearsStorageProvider");_4.require("dojo.gears");_4.require("dojox.storage.Provider");_4.require("dojox.storage.manager");_4.require("dojox.sql");if(_4.gears.available){(function(){_4.declare("dojox.storage.GearsStorageProvider",_6.storage.Provider,{constructor:function(){},TABLE_NAME:"__DOJO_STORAGE",initialized:false,_available:null,_storageReady:false,initialize:function(){if(_4.config["disableGearsStorage"]==true){return;}this.TABLE_NAME="__DOJO_STORAGE";this.initialized=true;_6.storage.manager.loaded();},isAvailable:function(){return this._available=_4.gears.available;},put:function(_7,_8,_9,_a){this._initStorage();if(!this.isValidKey(_7)){throw new Error("Invalid key given: "+_7);}_a=_a||this.DEFAULT_NAMESPACE;if(!this.isValidKey(_a)){throw new Error("Invalid namespace given: "+_7);}if(_4.isString(_8)){_8="string:"+_8;}else{_8=_4.toJson(_8);}try{_6.sql("DELETE FROM "+this.TABLE_NAME+" WHERE namespace = ? AND key = ?",_a,_7);_6.sql("INSERT INTO "+this.TABLE_NAME+" VALUES (?, ?, ?)",_a,_7,_8);}catch(e){console.debug("dojox.storage.GearsStorageProvider.put:",e);_9(this.FAILED,_7,e.toString(),_a);return;}if(_9){_9(_6.storage.SUCCESS,_7,null,_a);}},get:function(_b,_c){this._initStorage();if(!this.isValidKey(_b)){throw new Error("Invalid key given: "+_b);}_c=_c||this.DEFAULT_NAMESPACE;if(!this.isValidKey(_c)){throw new Error("Invalid namespace given: "+_b);}var _d=_6.sql("SELECT * FROM "+this.TABLE_NAME+" WHERE namespace = ? AND "+" key = ?",_c,_b);if(!_d.length){return null;}else{_d=_d[0].value;}if(_4.isString(_d)&&(/^string:/.test(_d))){_d=_d.substring("string:".length);}else{_d=_4.fromJson(_d);}return _d;},getNamespaces:function(){this._initStorage();var _e=[_6.storage.DEFAULT_NAMESPACE];var rs=_6.sql("SELECT namespace FROM "+this.TABLE_NAME+" DESC GROUP BY namespace");for(var i=0;i<rs.length;i++){if(rs[i].namespace!=_6.storage.DEFAULT_NAMESPACE){_e.push(rs[i].namespace);}}return _e;},getKeys:function(_f){this._initStorage();_f=_f||this.DEFAULT_NAMESPACE;if(!this.isValidKey(_f)){throw new Error("Invalid namespace given: "+_f);}var rs=_6.sql("SELECT key FROM "+this.TABLE_NAME+" WHERE namespace = ?",_f);var _10=[];for(var i=0;i<rs.length;i++){_10.push(rs[i].key);}return _10;},clear:function(_11){this._initStorage();_11=_11||this.DEFAULT_NAMESPACE;if(!this.isValidKey(_11)){throw new Error("Invalid namespace given: "+_11);}_6.sql("DELETE FROM "+this.TABLE_NAME+" WHERE namespace = ?",_11);},remove:function(key,_12){this._initStorage();if(!this.isValidKey(key)){throw new Error("Invalid key given: "+key);}_12=_12||this.DEFAULT_NAMESPACE;if(!this.isValidKey(_12)){throw new Error("Invalid namespace given: "+key);}_6.sql("DELETE FROM "+this.TABLE_NAME+" WHERE namespace = ? AND"+" key = ?",_12,key);},putMultiple:function(_13,_14,_15,_16){this._initStorage();if(!this.isValidKeyArray(_13)||!_14 instanceof Array||_13.length!=_14.length){throw new Error("Invalid arguments: keys = ["+_13+"], values = ["+_14+"]");}if(_16==null||typeof _16=="undefined"){_16=_6.storage.DEFAULT_NAMESPACE;}if(!this.isValidKey(_16)){throw new Error("Invalid namespace given: "+_16);}this._statusHandler=_15;try{_6.sql.open();_6.sql.db.execute("BEGIN TRANSACTION");var _17="REPLACE INTO "+this.TABLE_NAME+" VALUES (?, ?, ?)";for(var i=0;i<_13.length;i++){var _18=_14[i];if(_4.isString(_18)){_18="string:"+_18;}else{_18=_4.toJson(_18);}_6.sql.db.execute(_17,[_16,_13[i],_18]);}_6.sql.db.execute("COMMIT TRANSACTION");_6.sql.close();}catch(e){console.debug("dojox.storage.GearsStorageProvider.putMultiple:",e);if(_15){_15(this.FAILED,_13,e.toString(),_16);}return;}if(_15){_15(_6.storage.SUCCESS,_13,null,_16);}},getMultiple:function(_19,_1a){this._initStorage();if(!this.isValidKeyArray(_19)){throw new ("Invalid key array given: "+_19);}if(_1a==null||typeof _1a=="undefined"){_1a=_6.storage.DEFAULT_NAMESPACE;}if(!this.isValidKey(_1a)){throw new Error("Invalid namespace given: "+_1a);}var _1b="SELECT * FROM "+this.TABLE_NAME+" WHERE namespace = ? AND "+" key = ?";var _1c=[];for(var i=0;i<_19.length;i++){var _1d=_6.sql(_1b,_1a,_19[i]);if(!_1d.length){_1c[i]=null;}else{_1d=_1d[0].value;if(_4.isString(_1d)&&(/^string:/.test(_1d))){_1c[i]=_1d.substring("string:".length);}else{_1c[i]=_4.fromJson(_1d);}}}return _1c;},removeMultiple:function(_1e,_1f){this._initStorage();if(!this.isValidKeyArray(_1e)){throw new Error("Invalid arguments: keys = ["+_1e+"]");}if(_1f==null||typeof _1f=="undefined"){_1f=_6.storage.DEFAULT_NAMESPACE;}if(!this.isValidKey(_1f)){throw new Error("Invalid namespace given: "+_1f);}_6.sql.open();_6.sql.db.execute("BEGIN TRANSACTION");var _20="DELETE FROM "+this.TABLE_NAME+" WHERE namespace = ? AND key = ?";for(var i=0;i<_1e.length;i++){_6.sql.db.execute(_20,[_1f,_1e[i]]);}_6.sql.db.execute("COMMIT TRANSACTION");_6.sql.close();},isPermanent:function(){return true;},getMaximumSize:function(){return this.SIZE_NO_LIMIT;},hasSettingsUI:function(){return false;},showSettingsUI:function(){throw new Error(this.declaredClass+" does not support a storage settings user-interface");},hideSettingsUI:function(){throw new Error(this.declaredClass+" does not support a storage settings user-interface");},_initStorage:function(){if(this._storageReady){return;}if(!google.gears.factory.hasPermission){var _21=null;var _22=null;var msg="This site would like to use Google Gears to enable "+"enhanced functionality.";var _23=google.gears.factory.getPermission(_21,_22,msg);if(!_23){throw new Error("You must give permission to use Gears in order to "+"store data");}}try{_6.sql("CREATE TABLE IF NOT EXISTS "+this.TABLE_NAME+"( "+" namespace TEXT, "+" key TEXT, "+" value TEXT "+")");_6.sql("CREATE UNIQUE INDEX IF NOT EXISTS namespace_key_index"+" ON "+this.TABLE_NAME+" (namespace, key)");}catch(e){console.debug("dojox.storage.GearsStorageProvider._createTables:",e);throw new Error("Unable to create storage tables for Gears in "+"Dojo Storage");}this._storageReady=true;}});_6.storage.manager.register("dojox.storage.GearsStorageProvider",new _6.storage.GearsStorageProvider());})();}}}};});