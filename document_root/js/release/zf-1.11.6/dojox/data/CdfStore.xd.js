/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.data.CdfStore"],["require","dojo.data.util.sorter"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.data.CdfStore"]){_4._hasResource["dojox.data.CdfStore"]=true;_4.provide("dojox.data.CdfStore");_4.require("dojo.data.util.sorter");_6.data.ASYNC_MODE=0;_6.data.SYNC_MODE=1;_4.declare("dojox.data.CdfStore",null,{identity:"jsxid",url:"",xmlStr:"",data:null,label:"",mode:_6.data.ASYNC_MODE,constructor:function(_7){if(_7){this.url=_7.url;this.xmlStr=_7.xmlStr||_7.str;if(_7.data){this.xmlStr=this._makeXmlString(_7.data);}this.identity=_7.identity||this.identity;this.label=_7.label||this.label;this.mode=_7.mode!==undefined?_7.mode:this.mode;}this._modifiedItems={};this.byId=this.fetchItemByIdentity;},getValue:function(_8,_9,_a){return _8.getAttribute(_9)||_a;},getValues:function(_b,_c){var v=this.getValue(_b,_c,[]);return _4.isArray(v)?v:[v];},getAttributes:function(_d){return _d.getAttributeNames();},hasAttribute:function(_e,_f){return (this.getValue(_e,_f)!==undefined);},hasProperty:function(_10,_11){return this.hasAttribute(_10,_11);},containsValue:function(_12,_13,_14){var _15=this.getValues(_12,_13);for(var i=0;i<_15.length;i++){if(_15[i]===null){continue;}if((typeof _14==="string")){if(_15[i].toString&&_15[i].toString()===_14){return true;}}else{if(_15[i]===_14){return true;}}}return false;},isItem:function(_16){if(_16.getClass&&_16.getClass().equals(jsx3.xml.Entity.jsxclass)){return true;}return false;},isItemLoaded:function(_17){return this.isItem(_17);},loadItem:function(_18){},getFeatures:function(){return {"dojo.data.api.Read":true,"dojo.data.api.Write":true,"dojo.data.api.Identity":true};},getLabel:function(_19){if((this.label!=="")&&this.isItem(_19)){var _1a=this.getValue(_19,this.label);if(_1a){return _1a.toString();}}return undefined;},getLabelAttributes:function(_1b){if(this.label!==""){return [this.label];}return null;},fetch:function(_1c){_1c=_1c||{};if(!_1c.store){_1c.store=this;}if(_1c.mode!==undefined){this.mode=_1c.mode;}var _1d=this;var _1e=function(_1f){if(_1c.onError){var _20=_1c.scope||_4.global;_1c.onError.call(_20,_1f,_1c);}else{console.error("cdfStore Error:",_1f);}};var _21=function(_22,_23){_23=_23||_1c;var _24=_23.abort||null;var _25=false;var _26=_23.start?_23.start:0;var _27=(_23.count&&(_23.count!==Infinity))?(_26+_23.count):_22.length;_23.abort=function(){_25=true;if(_24){_24.call(_23);}};var _28=_23.scope||_4.global;if(!_23.store){_23.store=_1d;}if(_23.onBegin){_23.onBegin.call(_28,_22.length,_23);}if(_23.sort){_22.sort(_4.data.util.sorter.createSortFunction(_23.sort,_1d));}if(_23.onItem){for(var i=_26;(i<_22.length)&&(i<_27);++i){var _29=_22[i];if(!_25){_23.onItem.call(_28,_29,_23);}}}if(_23.onComplete&&!_25){if(!_23.onItem){_22=_22.slice(_26,_27);if(_23.byId){_22=_22[0];}}_23.onComplete.call(_28,_22,_23);}else{_22=_22.slice(_26,_27);if(_23.byId){_22=_22[0];}}return _22;};if(!this.url&&!this.data&&!this.xmlStr){_1e(new Error("No URL or data specified."));return false;}var _2a=_1c||"*";if(this.mode==_6.data.SYNC_MODE){var res=this._loadCDF();if(res instanceof Error){if(_1c.onError){_1c.onError.call(_1c.scope||_4.global,res,_1c);}else{console.error("CdfStore Error:",res);}return res;}this.cdfDoc=res;var _2b=this._getItems(this.cdfDoc,_2a);if(_2b&&_2b.length>0){_2b=_21(_2b,_1c);}else{_2b=_21([],_1c);}return _2b;}else{var dfd=this._loadCDF();dfd.addCallbacks(_4.hitch(this,function(_2c){var _2d=this._getItems(this.cdfDoc,_2a);if(_2d&&_2d.length>0){_21(_2d,_1c);}else{_21([],_1c);}}),_4.hitch(this,function(err){_1e(err,_1c);}));return dfd;}},_loadCDF:function(){var dfd=new _4.Deferred();if(this.cdfDoc){if(this.mode==_6.data.SYNC_MODE){return this.cdfDoc;}else{setTimeout(_4.hitch(this,function(){dfd.callback(this.cdfDoc);}),0);return dfd;}}this.cdfDoc=jsx3.xml.CDF.Document.newDocument();this.cdfDoc.subscribe("response",this,function(evt){dfd.callback(this.cdfDoc);});this.cdfDoc.subscribe("error",this,function(err){dfd.errback(err);});this.cdfDoc.setAsync(!this.mode);if(this.url){this.cdfDoc.load(this.url);}else{if(this.xmlStr){this.cdfDoc.loadXML(this.xmlStr);if(this.cdfDoc.getError().code){return new Error(this.cdfDoc.getError().description);}}}if(this.mode==_6.data.SYNC_MODE){return this.cdfDoc;}else{return dfd;}},_getItems:function(_2e,_2f){var itr=_2e.selectNodes(_2f.query,false,1);var _30=[];while(itr.hasNext()){_30.push(itr.next());}return _30;},close:function(_31){},newItem:function(_32,_33){_32=(_32||{});if(_32.tagName){if(_32.tagName!="record"){console.warn("Only record inserts are supported at this time");}delete _32.tagName;}_32.jsxid=_32.jsxid||this.cdfDoc.getKey();if(this.isItem(_33)){_33=this.getIdentity(_33);}var _34=this.cdfDoc.insertRecord(_32,_33);this._makeDirty(_34);return _34;},deleteItem:function(_35){this.cdfDoc.deleteRecord(this.getIdentity(_35));this._makeDirty(_35);return true;},setValue:function(_36,_37,_38){this._makeDirty(_36);_36.setAttribute(_37,_38);return true;},setValues:function(_39,_3a,_3b){this._makeDirty(_39);console.warn("cdfStore.setValues only partially implemented.");return _39.setAttribute(_3a,_3b);},unsetAttribute:function(_3c,_3d){this._makeDirty(_3c);_3c.removeAttribute(_3d);return true;},revert:function(){delete this.cdfDoc;this._modifiedItems={};return true;},isDirty:function(_3e){if(_3e){return !!this._modifiedItems[this.getIdentity(_3e)];}else{var _3f=false;for(var nm in this._modifiedItems){_3f=true;break;}return _3f;}},_makeDirty:function(_40){var id=this.getIdentity(_40);this._modifiedItems[id]=_40;},_makeXmlString:function(obj){var _41=function(obj,_42){var _43="";var nm;if(_4.isArray(obj)){for(var i=0;i<obj.length;i++){_43+=_41(obj[i],_42);}}else{if(_4.isObject(obj)){_43+="<"+_42+" ";for(nm in obj){if(!_4.isObject(obj[nm])){_43+=nm+"=\""+obj[nm]+"\" ";}}_43+=">";for(nm in obj){if(_4.isObject(obj[nm])){_43+=_41(obj[nm],nm);}}_43+="</"+_42+">";}}return _43;};return _41(obj,"data");},getIdentity:function(_44){return this.getValue(_44,this.identity);},getIdentityAttributes:function(_45){return [this.identity];},fetchItemByIdentity:function(_46){if(_4.isString(_46)){var id=_46;_46={query:"//record[@jsxid='"+id+"']",mode:_6.data.SYNC_MODE};}else{if(_46){_46.query="//record[@jsxid='"+_46.identity+"']";}if(!_46.mode){_46.mode=this.mode;}}_46.byId=true;return this.fetch(_46);},byId:function(_47){}});}}};});