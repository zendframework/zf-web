/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.data.JsonRestStore"],["require","dojox.data.ServiceStore"],["require","dojox.rpc.JsonRest"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.data.JsonRestStore"]){_4._hasResource["dojox.data.JsonRestStore"]=true;_4.provide("dojox.data.JsonRestStore");_4.require("dojox.data.ServiceStore");_4.require("dojox.rpc.JsonRest");_4.declare("dojox.data.JsonRestStore",_6.data.ServiceStore,{constructor:function(_7){_4.connect(_6.rpc.Rest._index,"onUpdate",this,function(_8,_9,_a,_b){var _c=this.service.servicePath;if(!_8.__id){console.log("no id on updated object ",_8);}else{if(_8.__id.substring(0,_c.length)==_c){this.onSet(_8,_9,_a,_b);}}});this.idAttribute=this.idAttribute||"id";if(typeof _7.target=="string"){_7.target=_7.target.match(/\/$/)||this.allowNoTrailingSlash?_7.target:(_7.target+"/");if(!this.service){this.service=_6.rpc.JsonRest.services[_7.target]||_6.rpc.Rest(_7.target,true);}}_6.rpc.JsonRest.registerService(this.service,_7.target,this.schema);this.schema=this.service._schema=this.schema||this.service._schema||{};this.service._store=this;this.service.idAsRef=this.idAsRef;this.schema._idAttr=this.idAttribute;var _d=_6.rpc.JsonRest.getConstructor(this.service);var _e=this;this._constructor=function(_f){_d.call(this,_f);_e.onNew(this);};this._constructor.prototype=_d.prototype;this._index=_6.rpc.Rest._index;},loadReferencedSchema:true,idAsRef:false,referenceIntegrity:true,target:"",allowNoTrailingSlash:false,newItem:function(_10,_11){_10=new this._constructor(_10);if(_11){var _12=this.getValue(_11.parent,_11.attribute,[]);_12=_12.concat([_10]);_10.__parent=_12;this.setValue(_11.parent,_11.attribute,_12);}return _10;},deleteItem:function(_13){var _14=[];var _15=_6.data._getStoreForItem(_13)||this;if(this.referenceIntegrity){_6.rpc.JsonRest._saveNotNeeded=true;var _16=_6.rpc.Rest._index;var _17=function(_18){var _19;_14.push(_18);_18.__checked=1;for(var i in _18){if(i.substring(0,2)!="__"){var _1a=_18[i];if(_1a==_13){if(_18!=_16){if(_18 instanceof Array){(_19=_19||[]).push(i);}else{(_6.data._getStoreForItem(_18)||_15).unsetAttribute(_18,i);}}}else{if((typeof _1a=="object")&&_1a){if(!_1a.__checked){_17(_1a);}if(typeof _1a.__checked=="object"&&_18!=_16){(_6.data._getStoreForItem(_18)||_15).setValue(_18,i,_1a.__checked);}}}}}if(_19){i=_19.length;_18=_18.__checked=_18.concat();while(i--){_18.splice(_19[i],1);}return _18;}return null;};_17(_16);_6.rpc.JsonRest._saveNotNeeded=false;var i=0;while(_14[i]){delete _14[i++].__checked;}}_6.rpc.JsonRest.deleteObject(_13);_15.onDelete(_13);},changing:function(_1b,_1c){_6.rpc.JsonRest.changing(_1b,_1c);},setValue:function(_1d,_1e,_1f){var old=_1d[_1e];var _20=_1d.__id?_6.data._getStoreForItem(_1d):this;if(_6.json.schema&&_20.schema&&_20.schema.properties){_6.json.schema.mustBeValid(_6.json.schema.checkPropertyChange(_1f,_20.schema.properties[_1e]));}if(_1e==_20.idAttribute){throw new Error("Can not change the identity attribute for an item");}_20.changing(_1d);_1d[_1e]=_1f;if(_1f&&!_1f.__parent){_1f.__parent=_1d;}_20.onSet(_1d,_1e,old,_1f);},setValues:function(_21,_22,_23){if(!_4.isArray(_23)){throw new Error("setValues expects to be passed an Array object as its value");}this.setValue(_21,_22,_23);},unsetAttribute:function(_24,_25){this.changing(_24);var old=_24[_25];delete _24[_25];this.onSet(_24,_25,old,undefined);},save:function(_26){if(!(_26&&_26.global)){(_26=_26||{}).service=this.service;}if("syncMode" in _26?_26.syncMode:this.syncMode){_6.rpc._sync=true;}var _27=_6.rpc.JsonRest.commit(_26);this.serverVersion=this._updates&&this._updates.length;return _27;},revert:function(_28){_6.rpc.JsonRest.revert(_28&&_28.global&&this.service);},isDirty:function(_29){return _6.rpc.JsonRest.isDirty(_29);},isItem:function(_2a,_2b){return _2a&&_2a.__id&&(_2b||this.service==_6.rpc.JsonRest.getServiceAndId(_2a.__id).service);},_doQuery:function(_2c){var _2d=typeof _2c.queryStr=="string"?_2c.queryStr:_2c.query;var _2e=_6.rpc.JsonRest.query(this.service,_2d,_2c);var _2f=this;if(this.loadReferencedSchema){_2e.addCallback(function(_30){var _31=_2e.ioArgs&&_2e.ioArgs.xhr&&_2e.ioArgs.xhr.getResponseHeader("Content-Type");var _32=_31&&_31.match(/definedby\s*=\s*([^;]*)/);if(_31&&!_32){_32=_2e.ioArgs.xhr.getResponseHeader("Link");_32=_32&&_32.match(/<([^>]*)>;\s*rel="?definedby"?/);}_32=_32&&_32[1];if(_32){var _33=_6.rpc.JsonRest.getServiceAndId((_2f.target+_32).replace(/^(.*\/)?(\w+:\/\/)|[^\/\.]+\/\.\.\/|^.*\/(\/)/,"$2$3"));var _34=_6.rpc.JsonRest.byId(_33.service,_33.id);_34.addCallbacks(function(_35){_4.mixin(_2f.schema,_35);return _30;},function(_36){console.error(_36);return _30;});return _34;}return undefined;});}return _2e;},_processResults:function(_37,_38){var _39=_37.length;return {totalCount:_38.fullLength||(_38.request.count==_39?(_38.request.start||0)+_39*2:_39),items:_37};},getConstructor:function(){return this._constructor;},getIdentity:function(_3a){var id=_3a.__clientId||_3a.__id;if(!id){return id;}var _3b=this.service.servicePath.replace(/[^\/]*$/,"");return id.substring(0,_3b.length)!=_3b?id:id.substring(_3b.length);},fetchItemByIdentity:function(_3c){var id=_3c.identity;var _3d=this;if(id.toString().match(/^(\w*:)?\//)){var _3e=_6.rpc.JsonRest.getServiceAndId(id);_3d=_3e.service._store;_3c.identity=_3e.id;}_3c._prefix=_3d.service.servicePath.replace(/[^\/]*$/,"");return _3d.inherited(arguments);},onSet:function(){},onNew:function(){},onDelete:function(){},getFeatures:function(){var _3f=this.inherited(arguments);_3f["dojo.data.api.Write"]=true;_3f["dojo.data.api.Notification"]=true;return _3f;},getParent:function(_40){return _40&&_40.__parent;}});_6.data.JsonRestStore.getStore=function(_41,_42){if(typeof _41.target=="string"){_41.target=_41.target.match(/\/$/)||_41.allowNoTrailingSlash?_41.target:(_41.target+"/");var _43=(_6.rpc.JsonRest.services[_41.target]||{})._store;if(_43){return _43;}}return new (_42||_6.data.JsonRestStore)(_41);};_6.data._getStoreForItem=function(_44){if(_44.__id){var _45=_6.rpc.JsonRest.getServiceAndId(_44.__id);if(_45&&_45.service._store){return _45.service._store;}else{var _46=_44.__id.toString().match(/.*\//)[0];return new _6.data.JsonRestStore({target:_46});}}return null;};_6.json.ref._useRefs=true;}}};});