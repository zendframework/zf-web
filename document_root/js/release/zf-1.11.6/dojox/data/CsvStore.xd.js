/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.data.CsvStore"],["require","dojo.data.util.filter"],["require","dojo.data.util.simpleFetch"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.data.CsvStore"]){_4._hasResource["dojox.data.CsvStore"]=true;_4.provide("dojox.data.CsvStore");_4.require("dojo.data.util.filter");_4.require("dojo.data.util.simpleFetch");_4.declare("dojox.data.CsvStore",null,{constructor:function(_7){this._attributes=[];this._attributeIndexes={};this._dataArray=[];this._arrayOfAllItems=[];this._loadFinished=false;if(_7.url){this.url=_7.url;}this._csvData=_7.data;if(_7.label){this.label=_7.label;}else{if(this.label===""){this.label=undefined;}}this._storeProp="_csvStore";this._idProp="_csvId";this._features={"dojo.data.api.Read":true,"dojo.data.api.Identity":true};this._loadInProgress=false;this._queuedFetches=[];this.identifier=_7.identifier;if(this.identifier===""){delete this.identifier;}else{this._idMap={};}if("separator" in _7){this.separator=_7.separator;}if("urlPreventCache" in _7){this.urlPreventCache=_7.urlPreventCache?true:false;}},url:"",label:"",identifier:"",separator:",",urlPreventCache:false,_assertIsItem:function(_8){if(!this.isItem(_8)){throw new Error(this.declaredClass+": a function was passed an item argument that was not an item");}},_getIndex:function(_9){var _a=this.getIdentity(_9);if(this.identifier){_a=this._idMap[_a];}return _a;},getValue:function(_b,_c,_d){this._assertIsItem(_b);var _e=_d;if(typeof _c==="string"){var ai=this._attributeIndexes[_c];if(ai!=null){var _f=this._dataArray[this._getIndex(_b)];_e=_f[ai]||_d;}}else{throw new Error(this.declaredClass+": a function was passed an attribute argument that was not a string");}return _e;},getValues:function(_10,_11){var _12=this.getValue(_10,_11);return (_12?[_12]:[]);},getAttributes:function(_13){this._assertIsItem(_13);var _14=[];var _15=this._dataArray[this._getIndex(_13)];for(var i=0;i<_15.length;i++){if(_15[i]!==""){_14.push(this._attributes[i]);}}return _14;},hasAttribute:function(_16,_17){this._assertIsItem(_16);if(typeof _17==="string"){var _18=this._attributeIndexes[_17];var _19=this._dataArray[this._getIndex(_16)];return (typeof _18!=="undefined"&&_18<_19.length&&_19[_18]!=="");}else{throw new Error(this.declaredClass+": a function was passed an attribute argument that was not a string");}},containsValue:function(_1a,_1b,_1c){var _1d=undefined;if(typeof _1c==="string"){_1d=_4.data.util.filter.patternToRegExp(_1c,false);}return this._containsValue(_1a,_1b,_1c,_1d);},_containsValue:function(_1e,_1f,_20,_21){var _22=this.getValues(_1e,_1f);for(var i=0;i<_22.length;++i){var _23=_22[i];if(typeof _23==="string"&&_21){return (_23.match(_21)!==null);}else{if(_20===_23){return true;}}}return false;},isItem:function(_24){if(_24&&_24[this._storeProp]===this){var _25=_24[this._idProp];if(this.identifier){var _26=this._dataArray[this._idMap[_25]];if(_26){return true;}}else{if(_25>=0&&_25<this._dataArray.length){return true;}}}return false;},isItemLoaded:function(_27){return this.isItem(_27);},loadItem:function(_28){},getFeatures:function(){return this._features;},getLabel:function(_29){if(this.label&&this.isItem(_29)){return this.getValue(_29,this.label);}return undefined;},getLabelAttributes:function(_2a){if(this.label){return [this.label];}return null;},_fetchItems:function(_2b,_2c,_2d){var _2e=this;var _2f=function(_30,_31){var _32=null;if(_30.query){var key,_33;_32=[];var _34=_30.queryOptions?_30.queryOptions.ignoreCase:false;var _35={};for(key in _30.query){_33=_30.query[key];if(typeof _33==="string"){_35[key]=_4.data.util.filter.patternToRegExp(_33,_34);}}for(var i=0;i<_31.length;++i){var _36=true;var _37=_31[i];for(key in _30.query){_33=_30.query[key];if(!_2e._containsValue(_37,key,_33,_35[key])){_36=false;}}if(_36){_32.push(_37);}}}else{_32=_31.slice(0,_31.length);}_2c(_32,_30);};if(this._loadFinished){_2f(_2b,this._arrayOfAllItems);}else{if(this.url!==""){if(this._loadInProgress){this._queuedFetches.push({args:_2b,filter:_2f});}else{this._loadInProgress=true;var _38={url:_2e.url,handleAs:"text",preventCache:_2e.urlPreventCache};var _39=_4.xhrGet(_38);_39.addCallback(function(_3a){try{_2e._processData(_3a);_2f(_2b,_2e._arrayOfAllItems);_2e._handleQueuedFetches();}catch(e){_2d(e,_2b);}});_39.addErrback(function(_3b){_2e._loadInProgress=false;if(_2d){_2d(_3b,_2b);}else{throw _3b;}});var _3c=null;if(_2b.abort){_3c=_2b.abort;}_2b.abort=function(){var df=_39;if(df&&df.fired===-1){df.cancel();df=null;}if(_3c){_3c.call(_2b);}};}}else{if(this._csvData){try{this._processData(this._csvData);this._csvData=null;_2f(_2b,this._arrayOfAllItems);}catch(e){_2d(e,_2b);}}else{var _3d=new Error(this.declaredClass+": No CSV source data was provided as either URL or String data input.");if(_2d){_2d(_3d,_2b);}else{throw _3d;}}}}},close:function(_3e){},_getArrayOfArraysFromCsvFileContents:function(_3f){if(_4.isString(_3f)){var _40=new RegExp("^\\s+","g");var _41=new RegExp("\\s+$","g");var _42=new RegExp("\"\"","g");var _43=[];var i;var _44=this._splitLines(_3f);for(i=0;i<_44.length;++i){var _45=_44[i];if(_45.length>0){var _46=_45.split(this.separator);var j=0;while(j<_46.length){var _47=_46[j];var _48=_47.replace(_40,"");var _49=_48.replace(_41,"");var _4a=_49.charAt(0);var _4b=_49.charAt(_49.length-1);var _4c=_49.charAt(_49.length-2);var _4d=_49.charAt(_49.length-3);if(_49.length===2&&_49=="\"\""){_46[j]="";}else{if((_4a=="\"")&&((_4b!="\"")||((_4b=="\"")&&(_4c=="\"")&&(_4d!="\"")))){if(j+1===_46.length){return;}var _4e=_46[j+1];_46[j]=_48+this.separator+_4e;_46.splice(j+1,1);}else{if((_4a=="\"")&&(_4b=="\"")){_49=_49.slice(1,(_49.length-1));_49=_49.replace(_42,"\"");}_46[j]=_49;j+=1;}}}_43.push(_46);}}this._attributes=_43.shift();for(i=0;i<this._attributes.length;i++){this._attributeIndexes[this._attributes[i]]=i;}this._dataArray=_43;}},_splitLines:function(_4f){var _50=[];var i;var _51="";var _52=false;for(i=0;i<_4f.length;i++){var c=_4f.charAt(i);switch(c){case "\"":_52=!_52;_51+=c;break;case "\r":if(_52){_51+=c;}else{_50.push(_51);_51="";if(i<(_4f.length-1)&&_4f.charAt(i+1)=="\n"){i++;}}break;case "\n":if(_52){_51+=c;}else{_50.push(_51);_51="";}break;default:_51+=c;}}if(_51!==""){_50.push(_51);}return _50;},_processData:function(_53){this._getArrayOfArraysFromCsvFileContents(_53);this._arrayOfAllItems=[];if(this.identifier){if(this._attributeIndexes[this.identifier]===undefined){throw new Error(this.declaredClass+": Identity specified is not a column header in the data set.");}}for(var i=0;i<this._dataArray.length;i++){var id=i;if(this.identifier){var _54=this._dataArray[i];id=_54[this._attributeIndexes[this.identifier]];this._idMap[id]=i;}this._arrayOfAllItems.push(this._createItemFromIdentity(id));}this._loadFinished=true;this._loadInProgress=false;},_createItemFromIdentity:function(_55){var _56={};_56[this._storeProp]=this;_56[this._idProp]=_55;return _56;},getIdentity:function(_57){if(this.isItem(_57)){return _57[this._idProp];}return null;},fetchItemByIdentity:function(_58){var _59;var _5a=_58.scope?_58.scope:_4.global;if(!this._loadFinished){var _5b=this;if(this.url!==""){if(this._loadInProgress){this._queuedFetches.push({args:_58});}else{this._loadInProgress=true;var _5c={url:_5b.url,handleAs:"text"};var _5d=_4.xhrGet(_5c);_5d.addCallback(function(_5e){try{_5b._processData(_5e);var _5f=_5b._createItemFromIdentity(_58.identity);if(!_5b.isItem(_5f)){_5f=null;}if(_58.onItem){_58.onItem.call(_5a,_5f);}_5b._handleQueuedFetches();}catch(error){if(_58.onError){_58.onError.call(_5a,error);}}});_5d.addErrback(function(_60){this._loadInProgress=false;if(_58.onError){_58.onError.call(_5a,_60);}});}}else{if(this._csvData){try{_5b._processData(_5b._csvData);_5b._csvData=null;_59=_5b._createItemFromIdentity(_58.identity);if(!_5b.isItem(_59)){_59=null;}if(_58.onItem){_58.onItem.call(_5a,_59);}}catch(e){if(_58.onError){_58.onError.call(_5a,e);}}}}}else{_59=this._createItemFromIdentity(_58.identity);if(!this.isItem(_59)){_59=null;}if(_58.onItem){_58.onItem.call(_5a,_59);}}},getIdentityAttributes:function(_61){if(this.identifier){return [this.identifier];}else{return null;}},_handleQueuedFetches:function(){if(this._queuedFetches.length>0){for(var i=0;i<this._queuedFetches.length;i++){var _62=this._queuedFetches[i];var _63=_62.filter;var _64=_62.args;if(_63){_63(_64,this._arrayOfAllItems);}else{this.fetchItemByIdentity(_62.args);}}this._queuedFetches=[];}}});_4.extend(_6.data.CsvStore,_4.data.util.simpleFetch);}}};});