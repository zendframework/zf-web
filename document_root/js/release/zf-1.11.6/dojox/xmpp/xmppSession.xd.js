/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.xmpp.xmppSession"],["require","dojox.xmpp.TransportSession"],["require","dojox.xmpp.RosterService"],["require","dojox.xmpp.PresenceService"],["require","dojox.xmpp.UserService"],["require","dojox.xmpp.ChatService"],["require","dojox.xmpp.sasl"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.xmpp.xmppSession"]){_4._hasResource["dojox.xmpp.xmppSession"]=true;_4.provide("dojox.xmpp.xmppSession");_4.require("dojox.xmpp.TransportSession");_4.require("dojox.xmpp.RosterService");_4.require("dojox.xmpp.PresenceService");_4.require("dojox.xmpp.UserService");_4.require("dojox.xmpp.ChatService");_4.require("dojox.xmpp.sasl");_6.xmpp.xmpp={STREAM_NS:"http://etherx.jabber.org/streams",CLIENT_NS:"jabber:client",STANZA_NS:"urn:ietf:params:xml:ns:xmpp-stanzas",SASL_NS:"urn:ietf:params:xml:ns:xmpp-sasl",BIND_NS:"urn:ietf:params:xml:ns:xmpp-bind",SESSION_NS:"urn:ietf:params:xml:ns:xmpp-session",BODY_NS:"http://jabber.org/protocol/httpbind",XHTML_BODY_NS:"http://www.w3.org/1999/xhtml",XHTML_IM_NS:"http://jabber.org/protocol/xhtml-im",INACTIVE:"Inactive",CONNECTED:"Connected",ACTIVE:"Active",TERMINATE:"Terminate",LOGIN_FAILURE:"LoginFailure",INVALID_ID:-1,NO_ID:0,error:{BAD_REQUEST:"bad-request",CONFLICT:"conflict",FEATURE_NOT_IMPLEMENTED:"feature-not-implemented",FORBIDDEN:"forbidden",GONE:"gone",INTERNAL_SERVER_ERROR:"internal-server-error",ITEM_NOT_FOUND:"item-not-found",ID_MALFORMED:"jid-malformed",NOT_ACCEPTABLE:"not-acceptable",NOT_ALLOWED:"not-allowed",NOT_AUTHORIZED:"not-authorized",SERVICE_UNAVAILABLE:"service-unavailable",SUBSCRIPTION_REQUIRED:"subscription-required",UNEXPECTED_REQUEST:"unexpected-request"}};_6.xmpp.xmppSession=function(_7){this.roster=[];this.chatRegister=[];this._iqId=Math.round(Math.random()*1000000000);if(_7&&_4.isObject(_7)){_4.mixin(this,_7);}this.session=new _6.xmpp.TransportSession(_7);_4.connect(this.session,"onReady",this,"onTransportReady");_4.connect(this.session,"onTerminate",this,"onTransportTerminate");_4.connect(this.session,"onProcessProtocolResponse",this,"processProtocolResponse");};_4.extend(_6.xmpp.xmppSession,{roster:[],chatRegister:[],_iqId:0,open:function(_8,_9,_a){if(!_8){throw new Error("User id cannot be null");}else{this.jid=_8;if(_8.indexOf("@")==-1){this.jid=this.jid+"@"+this.domain;}}if(_9){this.password=_9;}if(_a){this.resource=_a;}this.session.open();},close:function(){this.state=_6.xmpp.xmpp.TERMINATE;this.session.close(_6.xmpp.util.createElement("presence",{type:"unavailable",xmlns:_6.xmpp.xmpp.CLIENT_NS},true));},processProtocolResponse:function(_b){var _c=_b.nodeName;var _d=_c.indexOf(":");if(_d>0){_c=_c.substring(_d+1);}switch(_c){case "iq":case "presence":case "message":case "features":this[_c+"Handler"](_b);break;default:if(_b.getAttribute("xmlns")==_6.xmpp.xmpp.SASL_NS){this.saslHandler(_b);}}},messageHandler:function(_e){switch(_e.getAttribute("type")){case "chat":this.chatHandler(_e);break;case "normal":default:this.simpleMessageHandler(_e);}},iqHandler:function(_f){if(_f.getAttribute("type")=="set"){this.iqSetHandler(_f);return;}else{if(_f.getAttribute("type")=="get"){return;}}},presenceHandler:function(msg){switch(msg.getAttribute("type")){case "subscribe":this.presenceSubscriptionRequest(msg.getAttribute("from"));break;case "subscribed":case "unsubscribed":break;case "error":this.processXmppError(msg);break;default:this.presenceUpdate(msg);break;}},featuresHandler:function(msg){var _10=[];var _11=false;var _12=false;if(msg.hasChildNodes()){for(var i=0;i<msg.childNodes.length;i++){var n=msg.childNodes[i];switch(n.nodeName){case "mechanisms":for(var x=0;x<n.childNodes.length;x++){_10.push(n.childNodes[x].firstChild.nodeValue);}break;case "bind":_11=true;break;case "session":_12=true;}}}if(this.state==_6.xmpp.xmpp.CONNECTED){if(!this.auth){for(var i=0;i<_10.length;i++){try{this.auth=_6.xmpp.sasl.registry.match(_10[i],this);break;}catch(e){console.warn("No suitable auth mechanism found for: ",_10[i]);}}}else{if(_11){this.bindResource(_12);}}}},saslHandler:function(msg){if(msg.nodeName=="success"){this.auth.onSuccess();return;}if(msg.nodeName=="challenge"){this.auth.onChallenge(msg);return;}if(msg.hasChildNodes()){this.onLoginFailure(msg.firstChild.nodeName);this.session.setState("Terminate",msg.firstChild.nodeName);}},sendRestart:function(){this.session._sendRestart();},chatHandler:function(msg){var _13={from:msg.getAttribute("from"),to:msg.getAttribute("to")};var _14=null;for(var i=0;i<msg.childNodes.length;i++){var n=msg.childNodes[i];if(n.hasChildNodes()){switch(n.nodeName){case "thread":_13.chatid=n.firstChild.nodeValue;break;case "body":if(!n.getAttribute("xmlns")||(n.getAttribute("xmlns")=="")){_13.body=n.firstChild.nodeValue;}break;case "subject":_13.subject=n.firstChild.nodeValue;case "html":if(n.getAttribute("xmlns")==_6.xmpp.xmpp.XHTML_IM_NS){_13.xhtml=n.getElementsByTagName("body")[0];}break;case "x":break;default:}}}var _15=-1;if(_13.chatid){for(var i=0;i<this.chatRegister.length;i++){var ci=this.chatRegister[i];if(ci&&ci.chatid==_13.chatid){_15=i;break;}}}else{for(var i=0;i<this.chatRegister.length;i++){var ci=this.chatRegister[i];if(ci){if(ci.uid==this.getBareJid(_13.from)){_15=i;}}}}if(_15>-1&&_14){var _16=this.chatRegister[_15];_16.setState(_14);if(_16.firstMessage){if(_14==_6.xmpp.chat.ACTIVE_STATE){_16.useChatState=(_14!=null)?true:false;_16.firstMessage=false;}}}if((!_13.body||_13.body=="")&&!_13.xhtml){return;}if(_15>-1){var _16=this.chatRegister[_15];_16.recieveMessage(_13);}else{var _17=new _6.xmpp.ChatService();_17.uid=this.getBareJid(_13.from);_17.chatid=_13.chatid;_17.firstMessage=true;if(!_14||_14!=_6.xmpp.chat.ACTIVE_STATE){this.useChatState=false;}this.registerChatInstance(_17,_13);}},simpleMessageHandler:function(msg){},registerChatInstance:function(_18,_19){_18.setSession(this);this.chatRegister.push(_18);this.onRegisterChatInstance(_18,_19);_18.recieveMessage(_19,true);},iqSetHandler:function(msg){if(msg.hasChildNodes()){var fn=msg.firstChild;switch(fn.nodeName){case "query":if(fn.getAttribute("xmlns")=="jabber:iq:roster"){this.rosterSetHandler(fn);this.sendIqResult(msg.getAttribute("id"),msg.getAttribute("from"));}break;default:break;}}},sendIqResult:function(_1a,to){var req={id:_1a,to:to||this.domain,type:"result",from:this.jid+"/"+this.resource};this.dispatchPacket(_6.xmpp.util.createElement("iq",req,true));},rosterSetHandler:function(_1b){for(var i=0;i<_1b.childNodes.length;i++){var n=_1b.childNodes[i];if(n.nodeName=="item"){var _1c=false;var _1d=-1;var _1e=null;var _1f=null;for(var x=0;x<this.roster.length;x++){var r=this.roster[x];if(n.getAttribute("jid")==r.jid){_1c=true;if(n.getAttribute("subscription")=="remove"){_1e={id:r.jid,name:r.name,groups:[]};for(var y=0;y<r.groups.length;y++){_1e.groups.push(r.groups[y]);}this.roster.splice(x,1);_1d=_6.xmpp.roster.REMOVED;}else{_1f=_4.clone(r);var _20=n.getAttribute("name");if(_20){this.roster[x].name=_20;}r.groups=[];if(n.getAttribute("subscription")){r.status=n.getAttribute("subscription");}r.substatus=_6.xmpp.presence.SUBSCRIPTION_SUBSTATUS_NONE;if(n.getAttribute("ask")=="subscribe"){r.substatus=_6.xmpp.presence.SUBSCRIPTION_REQUEST_PENDING;}for(var y=0;y<n.childNodes.length;y++){var _21=n.childNodes[y];if((_21.nodeName=="group")&&(_21.hasChildNodes())){var _22=_21.firstChild.nodeValue;r.groups.push(_22);}}_1e=r;_1d=_6.xmpp.roster.CHANGED;}break;}}if(!_1c&&(n.getAttribute("subscription")!="remove")){r=this.createRosterEntry(n);_1e=r;_1d=_6.xmpp.roster.ADDED;}switch(_1d){case _6.xmpp.roster.ADDED:this.onRosterAdded(_1e);break;case _6.xmpp.roster.REMOVED:this.onRosterRemoved(_1e);break;case _6.xmpp.roster.CHANGED:this.onRosterChanged(_1e,_1f);break;}}}},presenceUpdate:function(msg){if(msg.getAttribute("to")){var jid=this.getBareJid(msg.getAttribute("to"));if(jid!=this.jid){return;}}var _23=this.getResourceFromJid(msg.getAttribute("from"));var p={from:this.getBareJid(msg.getAttribute("from")),resource:_23,show:_6.xmpp.presence.STATUS_ONLINE,priority:5,hasAvatar:false};if(msg.getAttribute("type")=="unavailable"){p.show=_6.xmpp.presence.STATUS_OFFLINE;}for(var i=0;i<msg.childNodes.length;i++){var n=msg.childNodes[i];if(n.hasChildNodes()){switch(n.nodeName){case "status":case "show":p[n.nodeName]=n.firstChild.nodeValue;break;case "status":p.priority=parseInt(n.firstChild.nodeValue);break;case "x":if(n.firstChild&&n.firstChild.firstChild&&n.firstChild.firstChild.nodeValue!=""){p.avatarHash=n.firstChild.firstChild.nodeValue;p.hasAvatar=true;}break;}}}this.onPresenceUpdate(p);},retrieveRoster:function(){var _24={id:this.getNextIqId(),from:this.jid+"/"+this.resource,type:"get"};var req=new _6.string.Builder(_6.xmpp.util.createElement("iq",_24,false));req.append(_6.xmpp.util.createElement("query",{xmlns:"jabber:iq:roster"},true));req.append("</iq>");var def=this.dispatchPacket(req,"iq",_24.id);def.addCallback(this,"onRetrieveRoster");},getRosterIndex:function(jid){if(jid.indexOf("@")==-1){jid+="@"+this.domain;}for(var i=0;i<this.roster.length;i++){if(jid==this.roster[i].jid){return i;}}return -1;},createRosterEntry:function(_25){var re={name:_25.getAttribute("name"),jid:_25.getAttribute("jid"),groups:[],status:_6.xmpp.presence.SUBSCRIPTION_NONE,substatus:_6.xmpp.presence.SUBSCRIPTION_SUBSTATUS_NONE};if(!re.name){re.name=re.id;}for(var i=0;i<_25.childNodes.length;i++){var n=_25.childNodes[i];if(n.nodeName=="group"&&n.hasChildNodes()){re.groups.push(n.firstChild.nodeValue);}}if(_25.getAttribute("subscription")){re.status=_25.getAttribute("subscription");}if(_25.getAttribute("ask")=="subscribe"){re.substatus=_6.xmpp.presence.SUBSCRIPTION_REQUEST_PENDING;}return re;},bindResource:function(_26){var _27={id:this.getNextIqId(),type:"set"};var _28=new _6.string.Builder(_6.xmpp.util.createElement("iq",_27,false));_28.append(_6.xmpp.util.createElement("bind",{xmlns:_6.xmpp.xmpp.BIND_NS},false));if(this.resource){_28.append(_6.xmpp.util.createElement("resource"));_28.append(this.resource);_28.append("</resource>");}_28.append("</bind></iq>");var def=this.dispatchPacket(_28,"iq",_27.id);def.addCallback(this,function(msg){this.onBindResource(msg,_26);return msg;});},getNextIqId:function(){return "im_"+this._iqId++;},presenceSubscriptionRequest:function(msg){this.onSubscriptionRequest(msg);},dispatchPacket:function(msg,_29,_2a){if(this.state!="Terminate"){return this.session.dispatchPacket(msg,_29,_2a);}else{}},setState:function(_2b,_2c){if(this.state!=_2b){if(this["on"+_2b]){this["on"+_2b](_2b,this.state,_2c);}this.state=_2b;}},search:function(_2d,_2e,_2f){var req={id:this.getNextIqId(),"xml:lang":this.lang,type:"set",from:this.jid+"/"+this.resource,to:_2e};var _30=new _6.string.Builder(_6.xmpp.util.createElement("iq",req,false));_30.append(_6.xmpp.util.createElement("query",{xmlns:"jabber:iq:search"},false));_30.append(_6.xmpp.util.createElement(_2f,{},false));_30.append(_2d);_30.append("</").append(_2f).append(">");_30.append("</query></iq>");var def=this.dispatchPacket(_30.toString,"iq",req.id);def.addCallback(this,"_onSearchResults");},_onSearchResults:function(msg){if((msg.getAttribute("type")=="result")&&(msg.hasChildNodes())){this.onSearchResults([]);}},onLogin:function(){this.retrieveRoster();},onLoginFailure:function(msg){},onBindResource:function(msg,_31){if(msg.getAttribute("type")=="result"){if((msg.hasChildNodes())&&(msg.firstChild.nodeName=="bind")){var _32=msg.firstChild;if((_32.hasChildNodes())&&(_32.firstChild.nodeName=="jid")){if(_32.firstChild.hasChildNodes()){var _33=_32.firstChild.firstChild.nodeValue;this.jid=this.getBareJid(_33);this.resource=this.getResourceFromJid(_33);}}if(_31){var _34={id:this.getNextIqId(),type:"set"};var _35=new _6.string.Builder(_6.xmpp.util.createElement("iq",_34,false));_35.append(_6.xmpp.util.createElement("session",{xmlns:_6.xmpp.xmpp.SESSION_NS},true));_35.append("</iq>");var def=this.dispatchPacket(_35,"iq",_34.id);def.addCallback(this,"onBindSession");return;}}else{}this.onLogin();}else{if(msg.getAttribute("type")=="error"){var err=this.processXmppError(msg);this.onLoginFailure(err);}}},onBindSession:function(msg){if(msg.getAttribute("type")=="error"){var err=this.processXmppError(msg);this.onLoginFailure(err);}else{this.onLogin();}},onSearchResults:function(_36){},onRetrieveRoster:function(msg){if((msg.getAttribute("type")=="result")&&msg.hasChildNodes()){var _37=msg.getElementsByTagName("query")[0];if(_37.getAttribute("xmlns")=="jabber:iq:roster"){for(var i=0;i<_37.childNodes.length;i++){if(_37.childNodes[i].nodeName=="item"){this.roster[i]=this.createRosterEntry(_37.childNodes[i]);}}}}else{if(msg.getAttribute("type")=="error"){}}this.setState(_6.xmpp.xmpp.ACTIVE);this.onRosterUpdated();return msg;},onRosterUpdated:function(){},onSubscriptionRequest:function(req){},onPresenceUpdate:function(p){},onTransportReady:function(){this.setState(_6.xmpp.xmpp.CONNECTED);this.rosterService=new _6.xmpp.RosterService(this);this.presenceService=new _6.xmpp.PresenceService(this);this.userService=new _6.xmpp.UserService(this);},onTransportTerminate:function(_38,_39,_3a){this.setState(_6.xmpp.xmpp.TERMINATE,_3a);},onConnected:function(){},onTerminate:function(_3b,_3c,_3d){},onActive:function(){},onRegisterChatInstance:function(_3e,_3f){},onRosterAdded:function(ri){},onRosterRemoved:function(ri){},onRosterChanged:function(ri,_40){},processXmppError:function(msg){var err={stanzaType:msg.nodeName,id:msg.getAttribute("id")};for(var i=0;i<msg.childNodes.length;i++){var n=msg.childNodes[i];switch(n.nodeName){case "error":err.errorType=n.getAttribute("type");for(var x=0;x<n.childNodes.length;x++){var cn=n.childNodes[x];if((cn.nodeName=="text")&&(cn.getAttribute("xmlns")==_6.xmpp.xmpp.STANZA_NS)&&cn.hasChildNodes()){err.message=cn.firstChild.nodeValue;}else{if((cn.getAttribute("xmlns")==_6.xmpp.xmpp.STANZA_NS)&&(!cn.hasChildNodes())){err.condition=cn.nodeName;}}}break;default:break;}}return err;},sendStanzaError:function(_41,to,id,_42,_43,_44){var req={type:"error"};if(to){req.to=to;}if(id){req.id=id;}var _45=new _6.string.Builder(_6.xmpp.util.createElement(_41,req,false));_45.append(_6.xmpp.util.createElement("error",{type:_42},false));_45.append(_6.xmpp.util.createElement("condition",{xmlns:_6.xmpp.xmpp.STANZA_NS},true));if(_44){var _46={xmlns:_6.xmpp.xmpp.STANZA_NS,"xml:lang":this.lang};_45.append(_6.xmpp.util.createElement("text",_46,false));_45.append(_44).append("</text>");}_45.append("</error></").append(_41).append(">");this.dispatchPacket(_45.toString());},getBareJid:function(jid){var i=jid.indexOf("/");if(i!=-1){return jid.substring(0,i);}return jid;},getResourceFromJid:function(jid){var i=jid.indexOf("/");if(i!=-1){return jid.substring((i+1),jid.length);}return "";}});}}};});