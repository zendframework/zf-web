/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.cometd.RestChannels"],["require","dojox.rpc.Client"],["requireIf",_3.data&&!!_3.data.JsonRestStore,"dojox.data.restListener"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.cometd.RestChannels"]){_4._hasResource["dojox.cometd.RestChannels"]=true;_4.provide("dojox.cometd.RestChannels");_4.require("dojox.rpc.Client");_4.requireIf(_6.data&&!!_6.data.JsonRestStore,"dojox.data.restListener");(function(){_4.declare("dojox.cometd.RestChannels",null,{constructor:function(_7){_4.mixin(this,_7);if(_6.rpc.Rest&&this.autoSubscribeRoot){var _8=_6.rpc.Rest._get;var _9=this;_6.rpc.Rest._get=function(_a,id){var _b=_4.xhrGet;_4.xhrGet=function(r){var _c=_9.autoSubscribeRoot;return (_c&&r.url.substring(0,_c.length)==_c)?_9.get(r.url,r):_b(r);};var _d=_8.apply(this,arguments);_4.xhrGet=_b;return _d;};}},absoluteUrl:function(_e,_f){return new _4._Url(_e,_f)+"";},acceptType:"application/rest+json,application/http;q=0.9,*/*;q=0.7",subscriptions:{},subCallbacks:{},autoReconnectTime:3000,reloadDataOnReconnect:true,sendAsJson:false,url:"/channels",autoSubscribeRoot:"/",open:function(){this.started=true;if(!this.connected){this.connectionId=_6.rpc.Client.clientId;var _10=this.createdClientId?"Client-Id":"Create-Client-Id";this.createdClientId=true;var _11={Accept:this.acceptType};_11[_10]=this.connectionId;var dfd=_4.xhrPost({headers:_11,url:this.url,noStatus:true});var _12=this;this.lastIndex=0;var _13,_14=function(_15){if(typeof _4=="undefined"){return null;}if(xhr&&xhr.status>400){return _13(true);}if(typeof _15=="string"){_15=_15.substring(_12.lastIndex);}var _16=xhr&&(xhr.contentType||xhr.getResponseHeader("Content-Type"))||(typeof _15!="string"&&"already json");var _17=_12.onprogress(xhr,_15,_16);if(_17){if(_13()){return new Error(_17);}}if(!xhr||xhr.readyState==4){xhr=null;if(_12.connected){_12.connected=false;_12.open();}}return _15;};_13=function(_18){if(xhr&&xhr.status==409){console.log("multiple tabs/windows open, polling");_12.disconnected();return null;}_12.createdClientId=false;_12.disconnected();return _18;};dfd.addCallbacks(_14,_13);var xhr=dfd.ioArgs.xhr;if(xhr){xhr.onreadystatechange=function(){var _19;try{if(xhr.readyState==3){_12.readyState=3;_19=xhr.responseText;}}catch(e){}if(typeof _19=="string"){_14(_19);}};}if(window.attachEvent){window.attachEvent("onunload",function(){_12.connected=false;if(xhr){xhr.abort();}});}this.connected=true;}},_send:function(_1a,_1b,_1c){if(this.sendAsJson){_1b.postData=_4.toJson({target:_1b.url,method:_1a,content:_1c,params:_1b.content,subscribe:_1b.headers["Subscribe"]});_1b.url=this.url;_1a="POST";}else{_1b.postData=_4.toJson(_1c);}return _4.xhr(_1a,_1b,_1b.postData);},subscribe:function(_1d,_1e){_1e=_1e||{};_1e.url=this.absoluteUrl(this.url,_1d);if(_1e.headers){delete _1e.headers.Range;}var _1f=this.subscriptions[_1d];var _20=_1e.method||"HEAD";var _21=_1e.since;var _22=_1e.callback;var _23=_1e.headers||(_1e.headers={});this.subscriptions[_1d]=_21||_1f||0;var _24=this.subCallbacks[_1d];if(_22){this.subCallbacks[_1d]=_24?function(m){_24(m);_22(m);}:_22;}if(!this.connected){this.open();}if(_1f===undefined||_1f!=_21){_23["Cache-Control"]="max-age=0";_21=typeof _21=="number"?new Date(_21).toUTCString():_21;if(_21){_23["Subscribe-Since"]=_21;}_23["Subscribe"]=_1e.unsubscribe?"none":"*";var dfd=this._send(_20,_1e);var _25=this;dfd.addBoth(function(_26){var xhr=dfd.ioArgs.xhr;if(!(_26 instanceof Error)){if(_1e.confirmation){_1e.confirmation();}}if(xhr&&xhr.getResponseHeader("Subscribed")=="OK"){var _27=xhr.getResponseHeader("Last-Modified");if(xhr.responseText){_25.subscriptions[_1d]=_27||new Date().toUTCString();}else{return null;}}else{if(xhr&&!(_26 instanceof Error)){delete _25.subscriptions[_1d];}}if(!(_26 instanceof Error)){var _28={responseText:xhr&&xhr.responseText,channel:_1d,getResponseHeader:function(_29){return xhr.getResponseHeader(_29);},getAllResponseHeaders:function(){return xhr.getAllResponseHeaders();},result:_26};if(_25.subCallbacks[_1d]){_25.subCallbacks[_1d](_28);}}else{if(_25.subCallbacks[_1d]){_25.subCallbacks[_1d](xhr);}}return _26;});return dfd;}return null;},publish:function(_2a,_2b){return this._send("POST",{url:_2a,contentType:"application/json"},_2b);},_processMessage:function(_2c){_2c.event=_2c.event||_2c.getResponseHeader("Event");if(_2c.event=="connection-conflict"){return "conflict";}try{_2c.result=_2c.result||_4.fromJson(_2c.responseText);}catch(e){}var _2d=this;var loc=_2c.channel=new _4._Url(this.url,_2c.source||_2c.getResponseHeader("Content-Location"))+"";if(loc in this.subscriptions&&_2c.getResponseHeader){this.subscriptions[loc]=_2c.getResponseHeader("Last-Modified");}if(this.subCallbacks[loc]){setTimeout(function(){_2d.subCallbacks[loc](_2c);},0);}this.receive(_2c);return null;},onprogress:function(xhr,_2e,_2f){if(!_2f||_2f.match(/application\/rest\+json/)){var _30=_2e.length;_2e=_2e.replace(/^\s*[,\[]?/,"[").replace(/[,\]]?\s*$/,"]");try{var _31=_4.fromJson(_2e);this.lastIndex+=_30;}catch(e){}}else{if(_6.io&&_6.io.httpParse&&_2f.match(/application\/http/)){var _32="";if(xhr&&xhr.getAllResponseHeaders){_32=xhr.getAllResponseHeaders();}_31=_6.io.httpParse(_2e,_32,xhr.readyState!=4);}else{if(typeof _2e=="object"){_31=_2e;}}}if(_31){for(var i=0;i<_31.length;i++){if(this._processMessage(_31[i])){return "conflict";}}return null;}if(!xhr){return "error";}if(xhr.readyState!=4){return null;}if(xhr.__proto__){xhr={channel:"channel",__proto__:xhr};}return this._processMessage(xhr);},get:function(_33,_34){(_34=_34||{}).method="GET";return this.subscribe(_33,_34);},receive:function(_35){if(_6.data&&_6.data.restListener){_6.data.restListener(_35);}},disconnected:function(){var _36=this;if(this.connected){this.connected=false;if(this.started){setTimeout(function(){var _37=_36.subscriptions;_36.subscriptions={};for(var i in _37){if(_36.reloadDataOnReconnect&&_6.rpc.JsonRest){delete _6.rpc.Rest._index[i];_6.rpc.JsonRest.fetch(i);}else{_36.subscribe(i,{since:_37[i]});}}_36.open();},this.autoReconnectTime);}}},unsubscribe:function(_38,_39){_39=_39||{};_39.unsubscribe=true;this.subscribe(_38,_39);},disconnect:function(){this.started=false;this.xhr.abort();}});var _3a=_6.cometd.RestChannels.defaultInstance=new _6.cometd.RestChannels();if(_6.cometd.connectionTypes){_3a.startup=function(_3b){_3a.open();this._cometd._deliver({channel:"/meta/connect",successful:true});};_3a.check=function(_3c,_3d,_3e){for(var i=0;i<_3c.length;i++){if(_3c[i]=="rest-channels"){return !_3e;}}return false;};_3a.deliver=function(_3f){};_4.connect(this,"receive",null,function(_40){_40.data=_40.result;this._cometd._deliver(_40);});_3a.sendMessages=function(_41){for(var i=0;i<_41.length;i++){var _42=_41[i];var _43=_42.channel;var _44=this._cometd;var _45={confirmation:function(){_44._deliver({channel:_43,successful:true});}};if(_43=="/meta/subscribe"){this.subscribe(_42.subscription,_45);}else{if(_43=="/meta/unsubscribe"){this.unsubscribe(_42.subscription,_45);}else{if(_43=="/meta/connect"){_45.confirmation();}else{if(_43=="/meta/disconnect"){_3a.disconnect();_45.confirmation();}else{if(_43.substring(0,6)!="/meta/"){this.publish(_43,_42.data);}}}}}}};_6.cometd.connectionTypes.register("rest-channels",_3a.check,_3a,false,true);}})();}}};});