/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.cometd._base"],["require","dojo.AdapterRegistry"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.cometd._base"]){_4._hasResource["dojox.cometd._base"]=true;_4.provide("dojox.cometd._base");_4.require("dojo.AdapterRegistry");_6.cometd={Connection:function(_7){_4.mixin(this,{prefix:_7,_status:"unconnected",_handshook:false,_initialized:false,_polling:false,expectedNetworkDelay:10000,connectTimeout:0,version:"1.0",minimumVersion:"0.9",clientId:null,messageId:0,batch:0,_isXD:false,handshakeReturn:null,currentTransport:null,url:null,lastMessage:null,_messageQ:[],handleAs:"json",_advice:{},_backoffInterval:0,_backoffIncrement:1000,_backoffMax:60000,_deferredSubscribes:{},_deferredUnsubscribes:{},_subscriptions:[],_extendInList:[],_extendOutList:[]});this.state=function(){return this._status;};this.init=function(_8,_9,_a){_9=_9||{};_9.version=this.version;_9.minimumVersion=this.minimumVersion;_9.channel="/meta/handshake";_9.id=""+this.messageId++;this.url=_8||_4.config["cometdRoot"];if(!this.url){throw "no cometd root";return null;}var _b="^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?$";var _c=(""+window.location).match(new RegExp(_b));if(_c[4]){var _d=_c[4].split(":");var _e=_d[0];var _f=_d[1]||"80";_c=this.url.match(new RegExp(_b));if(_c[4]){_d=_c[4].split(":");var _10=_d[0];var _11=_d[1]||"80";this._isXD=((_10!=_e)||(_11!=_f));}}if(!this._isXD){_9.supportedConnectionTypes=_4.map(_6.cometd.connectionTypes.pairs,"return item[0]");}_9=this._extendOut(_9);var _12={url:this.url,handleAs:this.handleAs,content:{"message":_4.toJson([_9])},load:_4.hitch(this,function(msg){this._backon();this._finishInit(msg);}),error:_4.hitch(this,function(e){this._backoff();this._finishInit(e);}),timeout:this.expectedNetworkDelay};if(_a){_4.mixin(_12,_a);}this._props=_9;for(var _13 in this._subscriptions){for(var sub in this._subscriptions[_13]){if(this._subscriptions[_13][sub].topic){_4.unsubscribe(this._subscriptions[_13][sub].topic);}}}this._messageQ=[];this._subscriptions=[];this._initialized=true;this._status="handshaking";this.batch=0;this.startBatch();var r;if(this._isXD){_12.callbackParamName="jsonp";r=_4.io.script.get(_12);}else{r=_4.xhrPost(_12);}return r;};this.publish=function(_14,_15,_16){var _17={data:_15,channel:_14};if(_16){_4.mixin(_17,_16);}this._sendMessage(_17);};this.subscribe=function(_18,_19,_1a,_1b){_1b=_1b||{};if(_19){var _1c=_7+_18;var _1d=this._subscriptions[_1c];if(!_1d||_1d.length==0){_1d=[];_1b.channel="/meta/subscribe";_1b.subscription=_18;this._sendMessage(_1b);var _1e=this._deferredSubscribes;if(_1e[_18]){_1e[_18].cancel();delete _1e[_18];}_1e[_18]=new _4.Deferred();}for(var i in _1d){if(_1d[i].objOrFunc===_19&&(!_1d[i].funcName&&!_1a||_1d[i].funcName==_1a)){return null;}}var _1f=_4.subscribe(_1c,_19,_1a);_1d.push({topic:_1f,objOrFunc:_19,funcName:_1a});this._subscriptions[_1c]=_1d;}var ret=this._deferredSubscribes[_18]||{};ret.args=_4._toArray(arguments);return ret;};this.unsubscribe=function(_20,_21,_22,_23){if((arguments.length==1)&&(!_4.isString(_20))&&(_20.args)){return this.unsubscribe.apply(this,_20.args);}var _24=_7+_20;var _25=this._subscriptions[_24];if(!_25||_25.length==0){return null;}var s=0;for(var i in _25){var sb=_25[i];if((!_21)||(sb.objOrFunc===_21&&(!sb.funcName&&!_22||sb.funcName==_22))){_4.unsubscribe(_25[i].topic);delete _25[i];}else{s++;}}if(s==0){_23=_23||{};_23.channel="/meta/unsubscribe";_23.subscription=_20;delete this._subscriptions[_24];this._sendMessage(_23);this._deferredUnsubscribes[_20]=new _4.Deferred();if(this._deferredSubscribes[_20]){this._deferredSubscribes[_20].cancel();delete this._deferredSubscribes[_20];}}return this._deferredUnsubscribes[_20];};this.disconnect=function(){for(var _26 in this._subscriptions){for(var sub in this._subscriptions[_26]){if(this._subscriptions[_26][sub].topic){_4.unsubscribe(this._subscriptions[_26][sub].topic);}}}this._subscriptions=[];this._messageQ=[];if(this._initialized&&this.currentTransport){this._initialized=false;this.currentTransport.disconnect();}if(!this._polling){this._publishMeta("connect",false);}this._initialized=false;this._handshook=false;this._status="disconnected";this._publishMeta("disconnect",true);};this.subscribed=function(_27,_28){};this.unsubscribed=function(_29,_2a){};this.tunnelInit=function(_2b,_2c){};this.tunnelCollapse=function(){};this._backoff=function(){if(!this._advice){this._advice={reconnect:"retry",interval:0};}else{if(!this._advice.interval){this._advice.interval=0;}}if(this._backoffInterval<this._backoffMax){this._backoffInterval+=this._backoffIncrement;}};this._backon=function(){this._backoffInterval=0;};this._interval=function(){var i=this._backoffInterval+(this._advice?(this._advice.interval?this._advice.interval:0):0);if(i>0){console.log("Retry in interval+backoff="+this._advice.interval+"+"+this._backoffInterval+"="+i+"ms");}return i;};this._publishMeta=function(_2d,_2e,_2f){try{var _30={cometd:this,action:_2d,successful:_2e,state:this.state()};if(_2f){_4.mixin(_30,_2f);}_4.publish(this.prefix+"/meta",[_30]);}catch(e){console.log(e);}};this._finishInit=function(_31){if(this._status!="handshaking"){return;}var _32=this._handshook;var _33=false;var _34={};if(_31 instanceof Error){_4.mixin(_34,{reestablish:false,failure:true,error:_31,advice:this._advice});}else{_31=_31[0];_31=this._extendIn(_31);this.handshakeReturn=_31;if(_31["advice"]){this._advice=_31.advice;}_33=_31.successful?_31.successful:false;if(_31.version<this.minimumVersion){if(console.log){console.log("cometd protocol version mismatch. We wanted",this.minimumVersion,"but got",_31.version);}_33=false;this._advice.reconnect="none";}_4.mixin(_34,{reestablish:_33&&_32,response:_31});}this._publishMeta("handshake",_33,_34);if(this._status!="handshaking"){return;}if(_33){this._status="connecting";this._handshook=true;this.currentTransport=_6.cometd.connectionTypes.match(_31.supportedConnectionTypes,_31.version,this._isXD);var _35=this.currentTransport;_35._cometd=this;_35.version=_31.version;this.clientId=_31.clientId;this.tunnelInit=_35.tunnelInit&&_4.hitch(_35,"tunnelInit");this.tunnelCollapse=_35.tunnelCollapse&&_4.hitch(_35,"tunnelCollapse");_35.startup(_31);}else{if(!this._advice||this._advice["reconnect"]!="none"){setTimeout(_4.hitch(this,"init",this.url,this._props),this._interval());}}};this._extendIn=function(_36){_4.forEach(_6.cometd._extendInList,function(f){_36=f(_36)||_36;});return _36;};this._extendOut=function(_37){_4.forEach(_6.cometd._extendOutList,function(f){_37=f(_37)||_37;});return _37;};this.deliver=function(_38){_4.forEach(_38,this._deliver,this);return _38;};this._deliver=function(_39){_39=this._extendIn(_39);if(!_39["channel"]){if(_39["success"]!==true){return;}}this.lastMessage=_39;if(_39.advice){this._advice=_39.advice;}var _3a=null;if((_39["channel"])&&(_39.channel.length>5)&&(_39.channel.substr(0,5)=="/meta")){switch(_39.channel){case "/meta/connect":var _3b={response:_39};if(_39.successful){if(this._status!="connected"){this._status="connected";this.endBatch();}}if(this._initialized){this._publishMeta("connect",_39.successful,_3b);}break;case "/meta/subscribe":_3a=this._deferredSubscribes[_39.subscription];try{if(!_39.successful){if(_3a){_3a.errback(new Error(_39.error));}this.currentTransport.cancelConnect();return;}if(_3a){_3a.callback(true);}this.subscribed(_39.subscription,_39);}catch(e){log.warn(e);}break;case "/meta/unsubscribe":_3a=this._deferredUnsubscribes[_39.subscription];try{if(!_39.successful){if(_3a){_3a.errback(new Error(_39.error));}this.currentTransport.cancelConnect();return;}if(_3a){_3a.callback(true);}this.unsubscribed(_39.subscription,_39);}catch(e){log.warn(e);}break;default:if(_39.successful&&!_39.successful){this.currentTransport.cancelConnect();return;}}}this.currentTransport.deliver(_39);if(_39.data){try{var _3c=[_39];var _3d=_7+_39.channel;var _3e=_39.channel.split("/");var _3f=_7;for(var i=1;i<_3e.length-1;i++){_4.publish(_3f+"/**",_3c);_3f+="/"+_3e[i];}_4.publish(_3f+"/**",_3c);_4.publish(_3f+"/*",_3c);_4.publish(_3d,_3c);}catch(e){console.log(e);}}};this._sendMessage=function(_40){if(this.currentTransport&&!this.batch){return this.currentTransport.sendMessages([_40]);}else{this._messageQ.push(_40);return null;}};this.startBatch=function(){this.batch++;};this.endBatch=function(){if(--this.batch<=0&&this.currentTransport&&this._status=="connected"){this.batch=0;var _41=this._messageQ;this._messageQ=[];if(_41.length>0){this.currentTransport.sendMessages(_41);}}};this._onUnload=function(){_4.addOnUnload(_6.cometd,"disconnect");};this._connectTimeout=function(){var _42=0;if(this._advice&&this._advice.timeout&&this.expectedNetworkDelay>0){_42=this._advice.timeout+this.expectedNetworkDelay;}if(this.connectTimeout>0&&this.connectTimeout<_42){return this.connectTimeout;}return _42;};},connectionTypes:new _4.AdapterRegistry(true)};_6.cometd.Connection.call(_6.cometd,"/cometd");_4.addOnUnload(_6.cometd,"_onUnload");}}};});