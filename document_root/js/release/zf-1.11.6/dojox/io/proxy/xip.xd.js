/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.io.proxy.xip"],["require","dojo.io.iframe"],["require","dojox.data.dom"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.io.proxy.xip"]){_4._hasResource["dojox.io.proxy.xip"]=true;_4.provide("dojox.io.proxy.xip");_4.require("dojo.io.iframe");_4.require("dojox.data.dom");_6.io.proxy.xip={xipClientUrl:((_4.config||djConfig)["xipClientUrl"])||_4.moduleUrl("dojox.io.proxy","xip_client.html"),urlLimit:4000,_callbackName:(_6._scopeName||"dojox")+".io.proxy.xip.fragmentReceived",_state:{},_stateIdCounter:0,_isWebKit:navigator.userAgent.indexOf("WebKit")!=-1,send:function(_7){var _8=this.xipClientUrl;if(_8.split(":")[0].match(/javascript/i)||_7._ifpServerUrl.split(":")[0].match(/javascript/i)){return;}var _9=_8.indexOf(":");var _a=_8.indexOf("/");if(_9==-1||_a<_9){var _b=window.location.href;if(_a==0){_8=_b.substring(0,_b.indexOf("/",9))+_8;}else{_8=_b.substring(0,(_b.lastIndexOf("/")+1))+_8;}}this.fullXipClientUrl=_8;if(typeof document.postMessage!="undefined"){document.addEventListener("message",_4.hitch(this,this.fragmentReceivedEvent),false);}this.send=this._realSend;return this._realSend(_7);},_realSend:function(_c){var _d="XhrIframeProxy"+(this._stateIdCounter++);_c._stateId=_d;var _e=_c._ifpServerUrl+"#0:init:id="+_d+"&client="+encodeURIComponent(this.fullXipClientUrl)+"&callback="+encodeURIComponent(this._callbackName);this._state[_d]={facade:_c,stateId:_d,clientFrame:_4.io.iframe.create(_d,"",_e),isSending:false,serverUrl:_c._ifpServerUrl,requestData:null,responseMessage:"",requestParts:[],idCounter:1,partIndex:0,serverWindow:null};return _d;},receive:function(_f,_10){var _11={};var _12=_10.split("&");for(var i=0;i<_12.length;i++){if(_12[i]){var _13=_12[i].split("=");_11[decodeURIComponent(_13[0])]=decodeURIComponent(_13[1]);}}var _14=this._state[_f];var _15=_14.facade;_15._setResponseHeaders(_11.responseHeaders);if(_11.status==0||_11.status){_15.status=parseInt(_11.status,10);}if(_11.statusText){_15.statusText=_11.statusText;}if(_11.responseText){_15.responseText=_11.responseText;var _16=_15.getResponseHeader("Content-Type");if(_16){var _17=_16.split(";")[0];if(_17.indexOf("application/xml")==0||_17.indexOf("text/xml")==0){_15.responseXML=_6.data.dom.createDocument(_11.responseText,_16);}}}_15.readyState=4;this.destroyState(_f);},frameLoaded:function(_18){var _19=this._state[_18];var _1a=_19.facade;var _1b=[];for(var _1c in _1a._requestHeaders){_1b.push(_1c+": "+_1a._requestHeaders[_1c]);}var _1d={uri:_1a._uri};if(_1b.length>0){_1d.requestHeaders=_1b.join("\r\n");}if(_1a._method){_1d.method=_1a._method;}if(_1a._bodyData){_1d.data=_1a._bodyData;}this.sendRequest(_18,_4.objectToQuery(_1d));},destroyState:function(_1e){var _1f=this._state[_1e];if(_1f){delete this._state[_1e];var _20=_1f.clientFrame.parentNode;_20.removeChild(_1f.clientFrame);_1f.clientFrame=null;_1f=null;}},createFacade:function(){if(arguments&&arguments[0]&&arguments[0].iframeProxyUrl){return new _6.io.proxy.xip.XhrIframeFacade(arguments[0].iframeProxyUrl);}else{return _6.io.proxy.xip._xhrObjOld.apply(_4,arguments);}},sendRequest:function(_21,_22){var _23=this._state[_21];if(!_23.isSending){_23.isSending=true;_23.requestData=_22||"";_23.serverWindow=frames[_23.stateId];if(!_23.serverWindow){_23.serverWindow=document.getElementById(_23.stateId).contentWindow;}if(typeof document.postMessage=="undefined"){if(_23.serverWindow.contentWindow){_23.serverWindow=_23.serverWindow.contentWindow;}}this.sendRequestStart(_21);}},sendRequestStart:function(_24){var _25=this._state[_24];_25.requestParts=[];var _26=_25.requestData;var _27=_25.serverUrl.length;var _28=this.urlLimit-_27;var _29=0;while((_26.length-_29)+_27>this.urlLimit){var _2a=_26.substring(_29,_29+_28);var _2b=_2a.lastIndexOf("%");if(_2b==_2a.length-1||_2b==_2a.length-2){_2a=_2a.substring(0,_2b);}_25.requestParts.push(_2a);_29+=_2a.length;}_25.requestParts.push(_26.substring(_29,_26.length));_25.partIndex=0;this.sendRequestPart(_24);},sendRequestPart:function(_2c){var _2d=this._state[_2c];if(_2d.partIndex<_2d.requestParts.length){var _2e=_2d.requestParts[_2d.partIndex];var cmd="part";if(_2d.partIndex+1==_2d.requestParts.length){cmd="end";}else{if(_2d.partIndex==0){cmd="start";}}this.setServerUrl(_2c,cmd,_2e);_2d.partIndex++;}},setServerUrl:function(_2f,cmd,_30){var _31=this.makeServerUrl(_2f,cmd,_30);var _32=this._state[_2f];if(this._isWebKit){_32.serverWindow.location=_31;}else{_32.serverWindow.location.replace(_31);}},makeServerUrl:function(_33,cmd,_34){var _35=this._state[_33];var _36=_35.serverUrl+"#"+(_35.idCounter++)+":"+cmd;if(_34){_36+=":"+_34;}return _36;},fragmentReceivedEvent:function(evt){if(evt.uri.split("#")[0]==this.fullXipClientUrl){this.fragmentReceived(evt.data);}},fragmentReceived:function(_37){var _38=_37.indexOf("#");var _39=_37.substring(0,_38);var _3a=_37.substring(_38+1,_37.length);var msg=this.unpackMessage(_3a);var _3b=this._state[_39];switch(msg.command){case "loaded":this.frameLoaded(_39);break;case "ok":this.sendRequestPart(_39);break;case "start":_3b.responseMessage=""+msg.message;this.setServerUrl(_39,"ok");break;case "part":_3b.responseMessage+=msg.message;this.setServerUrl(_39,"ok");break;case "end":this.setServerUrl(_39,"ok");_3b.responseMessage+=msg.message;this.receive(_39,_3b.responseMessage);break;}},unpackMessage:function(_3c){var _3d=_3c.split(":");var _3e=_3d[1];_3c=_3d[2]||"";var _3f=null;if(_3e=="init"){var _40=_3c.split("&");_3f={};for(var i=0;i<_40.length;i++){var _41=_40[i].split("=");_3f[decodeURIComponent(_41[0])]=decodeURIComponent(_41[1]);}}return {command:_3e,message:_3c,config:_3f};}};_6.io.proxy.xip._xhrObjOld=_4._xhrObj;_4._xhrObj=_6.io.proxy.xip.createFacade;_6.io.proxy.xip.XhrIframeFacade=function(_42){this._requestHeaders={};this._allResponseHeaders=null;this._responseHeaders={};this._method=null;this._uri=null;this._bodyData=null;this.responseText=null;this.responseXML=null;this.status=null;this.statusText=null;this.readyState=0;this._ifpServerUrl=_42;this._stateId=null;};_4.extend(_6.io.proxy.xip.XhrIframeFacade,{open:function(_43,uri){this._method=_43;this._uri=uri;this.readyState=1;},setRequestHeader:function(_44,_45){this._requestHeaders[_44]=_45;},send:function(_46){this._bodyData=_46;this._stateId=_6.io.proxy.xip.send(this);this.readyState=2;},abort:function(){_6.io.proxy.xip.destroyState(this._stateId);},getAllResponseHeaders:function(){return this._allResponseHeaders;},getResponseHeader:function(_47){return this._responseHeaders[_47];},_setResponseHeaders:function(_48){if(_48){this._allResponseHeaders=_48;_48=_48.replace(/\r/g,"");var _49=_48.split("\n");for(var i=0;i<_49.length;i++){if(_49[i]){var _4a=_49[i].split(": ");this._responseHeaders[_4a[0]]=_4a[1];}}}}});}}};});