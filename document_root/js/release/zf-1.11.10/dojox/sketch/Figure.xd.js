/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.sketch.Figure"],["require","dojox.gfx"],["require","dojox.sketch.UndoStack"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.sketch.Figure"]){_4._hasResource["dojox.sketch.Figure"]=true;_4.provide("dojox.sketch.Figure");_4.experimental("dojox.sketch");_4.require("dojox.gfx");_4.require("dojox.sketch.UndoStack");(function(){var ta=_6.sketch;ta.tools={};ta.registerTool=function(_7,fn){ta.tools[_7]=fn;};ta.Figure=function(_8){var _9=this;this.annCounter=1;this.shapes=[];this.image=null;this.imageSrc=null;this.size={w:0,h:0};this.surface=null;this.group=null;this.node=null;this.zoomFactor=1;this.tools=null;this.obj={};_4.mixin(this,_8);this.selected=[];this.hasSelections=function(){return this.selected.length>0;};this.isSelected=function(_a){for(var i=0;i<_9.selected.length;i++){if(_9.selected[i]==_a){return true;}}return false;};this.select=function(_b){if(!_9.isSelected(_b)){_9.clearSelections();_9.selected=[_b];}_b.setMode(ta.Annotation.Modes.View);_b.setMode(ta.Annotation.Modes.Edit);};this.deselect=function(_c){var _d=-1;for(var i=0;i<_9.selected.length;i++){if(_9.selected[i]==_c){_d=i;break;}}if(_d>-1){_c.setMode(ta.Annotation.Modes.View);_9.selected.splice(_d,1);}return _c;};this.clearSelections=function(){for(var i=0;i<_9.selected.length;i++){_9.selected[i].setMode(ta.Annotation.Modes.View);}_9.selected=[];};this.replaceSelection=function(n,o){if(!_9.isSelected(o)){_9.select(n);return;}var _e=-1;for(var i=0;i<_9.selected.length;i++){if(_9.selected[i]==o){_e=i;break;}}if(_e>-1){_9.selected.splice(_e,1,n);}};this._c=null;this._ctr=null;this._lp=null;this._action=null;this._prevState=null;this._startPoint=null;this._ctool=null;this._start=null;this._end=null;this._absEnd=null;this._cshape=null;this._dblclick=function(e){var o=_9._fromEvt(e);if(o){_9.onDblClickShape(o,e);}};this._keydown=function(e){var _f=false;if(e.ctrlKey){if(e.keyCode===90||e.keyCode===122){_9.undo();_f=true;}else{if(e.keyCode===89||e.keyCode===121){_9.redo();_f=true;}}}if(e.keyCode===46||e.keyCode===8){_9._delete(_9.selected);_f=true;}if(_f){_4.stopEvent(e);}};this._md=function(e){if(_6.gfx.renderer=="vml"){_9.node.focus();}var o=_9._fromEvt(e);_9._startPoint={x:e.pageX,y:e.pageY};_9._ctr=_4.position(_9.node);var _10={x:_9.node.scrollLeft,y:_9.node.scrollTop};_9._ctr={x:_9._ctr.x-_10.x,y:_9._ctr.y-_10.y};var X=e.clientX-_9._ctr.x,Y=e.clientY-_9._ctr.y;_9._lp={x:X,y:Y};_9._start={x:X,y:Y};_9._end={x:X,y:Y};_9._absEnd={x:X,y:Y};if(!o){_9.clearSelections();_9._ctool.onMouseDown(e);}else{if(o.type&&o.type()!="Anchor"){if(!_9.isSelected(o)){_9.select(o);_9._sameShapeSelected=false;}else{_9._sameShapeSelected=true;}}o.beginEdit();_9._c=o;}};this._mm=function(e){if(!_9._ctr){return;}var x=e.clientX-_9._ctr.x;var y=e.clientY-_9._ctr.y;var dx=x-_9._lp.x;var dy=y-_9._lp.y;_9._absEnd={x:x,y:y};if(_9._c){_9._c.setBinding({dx:dx/_9.zoomFactor,dy:dy/_9.zoomFactor});_9._lp={x:x,y:y};}else{_9._end={x:dx,y:dy};var _11={x:Math.min(_9._start.x,_9._absEnd.x),y:Math.min(_9._start.y,_9._absEnd.y),width:Math.abs(_9._start.x-_9._absEnd.x),height:Math.abs(_9._start.y-_9._absEnd.y)};if(_11.width&&_11.height){_9._ctool.onMouseMove(e,_11);}}};this._mu=function(e){if(_9._c){_9._c.endEdit();}else{_9._ctool.onMouseUp(e);}_9._c=_9._ctr=_9._lp=_9._action=_9._prevState=_9._startPoint=null;_9._cshape=_9._start=_9._end=_9._absEnd=null;};this.initUndoStack();};var p=ta.Figure.prototype;p.initUndoStack=function(){this.history=new ta.UndoStack(this);};p.setTool=function(t){this._ctool=t;};p.gridSize=0;p._calCol=function(v){return this.gridSize?(Math.round(v/this.gridSize)*this.gridSize):v;};p._delete=function(arr,_12){for(var i=0;i<arr.length;i++){arr[i].setMode(ta.Annotation.Modes.View);arr[i].destroy(_12);this.remove(arr[i]);this._remove(arr[i]);if(!_12){arr[i].onRemove();}}arr.splice(0,arr.length);};p.onDblClickShape=function(_13,e){if(_13["onDblClick"]){_13.onDblClick(e);}};p.onCreateShape=function(_14){};p.onBeforeCreateShape=function(_15){};p.initialize=function(_16){this.node=_16;this.surface=_6.gfx.createSurface(_16,this.size.w,this.size.h);this.group=this.surface.createGroup();this._cons=[];var es=this.surface.getEventSource();this._cons.push(_4.connect(es,"ondraggesture",_4.stopEvent),_4.connect(es,"ondragenter",_4.stopEvent),_4.connect(es,"ondragover",_4.stopEvent),_4.connect(es,"ondragexit",_4.stopEvent),_4.connect(es,"ondragstart",_4.stopEvent),_4.connect(es,"onselectstart",_4.stopEvent),_4.connect(es,"onmousedown",this._md),_4.connect(es,"onmousemove",this._mm),_4.connect(es,"onmouseup",this._mu),_4.connect(es,"onclick",this,"onClick"),_4.connect(es,"ondblclick",this._dblclick),_4.connect(_16,"onkeydown",this._keydown));this.image=this.group.createImage({width:this.imageSize.w,height:this.imageSize.h,src:this.imageSrc});};p.destroy=function(_17){if(!this.node){return;}if(!_17){if(this.history){this.history.destroy();}if(this._subscribed){_4.unsubscribe(this._subscribed);delete this._subscribed;}}_4.forEach(this._cons,_4.disconnect);this._cons=[];_4.empty(this.node);this.group=this.surface=null;this.obj={};this.shapes=[];};p.nextKey=function(){return "annotation-"+this.annCounter++;};p.draw=function(){};p.zoom=function(pct){this.zoomFactor=pct/100;var w=this.size.w*this.zoomFactor;var h=this.size.h*this.zoomFactor;this.surface.setDimensions(w,h);this.group.setTransform(_6.gfx.matrix.scale(this.zoomFactor,this.zoomFactor));for(var i=0;i<this.shapes.length;i++){this.shapes[i].zoom(this.zoomFactor);}};p.getFit=function(){var wF=(this.node.parentNode.offsetWidth-5)/this.size.w;var hF=(this.node.parentNode.offsetHeight-5)/this.size.h;return Math.min(wF,hF)*100;};p.unzoom=function(){this.zoomFactor=1;this.surface.setDimensions(this.size.w,this.size.h);this.group.setTransform();};p._add=function(obj){this.obj[obj._key]=obj;};p._remove=function(obj){if(this.obj[obj._key]){delete this.obj[obj._key];}};p._get=function(key){if(key&&key.indexOf("bounding")>-1){key=key.replace("-boundingBox","");}else{if(key&&key.indexOf("-labelShape")>-1){key=key.replace("-labelShape","");}}return this.obj[key];};p._keyFromEvt=function(e){var key=e.target.id+"";if(key.length==0){var p=e.target.parentNode;var _18=this.surface.getEventSource();while(p&&p.id.length==0&&p!=_18){p=p.parentNode;}key=p.id;}return key;};p._fromEvt=function(e){return this._get(this._keyFromEvt(e));};p.add=function(_19){for(var i=0;i<this.shapes.length;i++){if(this.shapes[i]==_19){return true;}}this.shapes.push(_19);return true;};p.remove=function(_1a){var idx=-1;for(var i=0;i<this.shapes.length;i++){if(this.shapes[i]==_1a){idx=i;break;}}if(idx>-1){this.shapes.splice(idx,1);}return _1a;};p.get=function(id){for(var i=0;i<this.shapes.length;i++){if(this.shapes[i].id==id){return this.shapes[i];}}return null;};p.convert=function(ann,t){var _1b=t+"Annotation";if(!ta[_1b]){return;}var _1c=ann.type(),id=ann.id,_1d=ann.label,_1e=ann.mode,_1f=ann.tokenId;var _20,end,_21,_22;switch(_1c){case "Preexisting":case "Lead":_22={dx:ann.transform.dx,dy:ann.transform.dy};_20={x:ann.start.x,y:ann.start.y};end={x:ann.end.x,y:ann.end.y};var cx=end.x-((end.x-_20.x)/2);var cy=end.y-((end.y-_20.y)/2);_21={x:cx,y:cy};break;case "SingleArrow":case "DoubleArrow":_22={dx:ann.transform.dx,dy:ann.transform.dy};_20={x:ann.start.x,y:ann.start.y};end={x:ann.end.x,y:ann.end.y};_21={x:ann.control.x,y:ann.control.y};break;case "Underline":_22={dx:ann.transform.dx,dy:ann.transform.dy};_20={x:ann.start.x,y:ann.start.y};_21={x:_20.x+50,y:_20.y+50};end={x:_20.x+100,y:_20.y+100};break;case "Brace":}var n=new ta[_1b](this,id);if(n.type()=="Underline"){n.transform={dx:_22.dx+_20.x,dy:_22.dy+_20.y};}else{if(n.transform){n.transform=_22;}if(n.start){n.start=_20;}}if(n.end){n.end=end;}if(n.control){n.control=_21;}n.label=_1d;n.token=_4.lang.shallowCopy(ann.token);n.initialize();this.replaceSelection(n,ann);this._remove(ann);this.remove(ann);ann.destroy();n.setMode(_1e);};p.setValue=function(_23){var obj=_6.xml.DomParser.parse(_23);var _24=this.node;this.load(obj,_24);};p.load=function(obj,n){if(this.surface){this.destroy(true);}var _25=obj.documentElement;this.size={w:parseFloat(_25.getAttribute("width"),10),h:parseFloat(_25.getAttribute("height"),10)};var g=_25.childrenByName("g")[0];var img=g.childrenByName("image")[0];this.imageSize={w:parseFloat(img.getAttribute("width"),10),h:parseFloat(img.getAttribute("height"),10)};this.imageSrc=img.getAttribute("xlink:href");this.initialize(n);var ann=g.childrenByName("g");for(var i=0;i<ann.length;i++){this._loadAnnotation(ann[i]);}if(this._loadDeferred){this._loadDeferred.callback(this);this._loadDeferred=null;}this.onLoad();};p.onLoad=function(){};p.onClick=function(){};p._loadAnnotation=function(obj){var _26=obj.getAttribute("dojoxsketch:type")+"Annotation";if(ta[_26]){var a=new ta[_26](this,obj.id);a.initialize(obj);this.nextKey();a.setMode(ta.Annotation.Modes.View);this._add(a);return a;}return null;};p.onUndo=function(){};p.onBeforeUndo=function(){};p.onRedo=function(){};p.onBeforeRedo=function(){};p.undo=function(){if(this.history){this.onBeforeUndo();this.history.undo();this.onUndo();}};p.redo=function(){if(this.history){this.onBeforeRedo();this.history.redo();this.onRedo();}};p.serialize=function(){var s="<svg xmlns=\"http://www.w3.org/2000/svg\" "+"xmlns:xlink=\"http://www.w3.org/1999/xlink\" "+"xmlns:dojoxsketch=\"http://dojotoolkit.org/dojox/sketch\" "+"width=\""+this.size.w+"\" height=\""+this.size.h+"\">"+"<g>"+"<image xlink:href=\""+this.imageSrc+"\" x=\"0\" y=\"0\" width=\""+this.size.w+"\" height=\""+this.size.h+"\" />";for(var i=0;i<this.shapes.length;i++){s+=this.shapes[i].serialize();}s+="</g></svg>";return s;};p.getValue=p.serialize;})();}}};});