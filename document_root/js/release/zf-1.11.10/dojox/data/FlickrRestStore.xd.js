/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dojox.data.FlickrRestStore"],["require","dojox.data.FlickrStore"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dojox.data.FlickrRestStore"]){_4._hasResource["dojox.data.FlickrRestStore"]=true;_4.provide("dojox.data.FlickrRestStore");_4.require("dojox.data.FlickrStore");_4.declare("dojox.data.FlickrRestStore",_6.data.FlickrStore,{constructor:function(_7){if(_7){if(_7.label){this.label=_7.label;}if(_7.apikey){this._apikey=_7.apikey;}}this._cache=[];this._prevRequests={};this._handlers={};this._prevRequestRanges=[];this._maxPhotosPerUser={};this._id=_6.data.FlickrRestStore.prototype._id++;},_id:0,_requestCount:0,_flickrRestUrl:"http://www.flickr.com/services/rest/",_apikey:null,_storeRef:"_S",_cache:null,_prevRequests:null,_handlers:null,_sortAttributes:{"date-posted":true,"date-taken":true,"interestingness":true},_fetchItems:function(_8,_9,_a){var _b={};if(!_8.query){_8.query=_b={};}else{_4.mixin(_b,_8.query);}var _c=[];var _d=[];var _e={format:"json",method:"flickr.photos.search",api_key:this._apikey,extras:"owner_name,date_upload,date_taken"};var _f=false;if(_b.userid){_f=true;_e.user_id=_8.query.userid;_c.push("userid"+_8.query.userid);}if(_b.groupid){_f=true;_e.group_id=_b.groupid;_c.push("groupid"+_b.groupid);}if(_b.apikey){_f=true;_e.api_key=_8.query.apikey;_d.push("api"+_8.query.apikey);}else{if(_e.api_key){_f=true;_8.query.apikey=_e.api_key;_d.push("api"+_e.api_key);}else{throw Error("dojox.data.FlickrRestStore: An API key must be specified.");}}_8._curCount=_8.count;if(_b.page){_e.page=_8.query.page;_d.push("page"+_e.page);}else{if(("start" in _8)&&_8.start!==null){if(!_8.count){_8.count=20;}var _10=_8.start%_8.count;var _11=_8.start,_12=_8.count;if(_10!==0){if(_11<_12/2){_12=_11+_12;_11=0;}else{var _13=20,div=2;for(var i=_13;i>0;i--){if(_11%i===0&&(_11/i)>=_12){div=i;break;}}_12=_11/div;}_8._realStart=_8.start;_8._realCount=_8.count;_8._curStart=_11;_8._curCount=_12;}else{_8._realStart=_8._realCount=null;_8._curStart=_8.start;_8._curCount=_8.count;}_e.page=(_11/_12)+1;_d.push("page"+_e.page);}}if(_8._curCount){_e.per_page=_8._curCount;_d.push("count"+_8._curCount);}if(_b.lang){_e.lang=_8.query.lang;_c.push("lang"+_8.lang);}if(_b.setid){_e.method="flickr.photosets.getPhotos";_e.photoset_id=_8.query.setid;_c.push("set"+_8.query.setid);}if(_b.tags){if(_b.tags instanceof Array){_e.tags=_b.tags.join(",");}else{_e.tags=_b.tags;}_c.push("tags"+_e.tags);if(_b["tag_mode"]&&(_b.tag_mode.toLowerCase()==="any"||_b.tag_mode.toLowerCase()==="all")){_e.tag_mode=_b.tag_mode;}}if(_b.text){_e.text=_b.text;_c.push("text:"+_b.text);}if(_b.sort&&_b.sort.length>0){if(!_b.sort[0].attribute){_b.sort[0].attribute="date-posted";}if(this._sortAttributes[_b.sort[0].attribute]){if(_b.sort[0].descending){_e.sort=_b.sort[0].attribute+"-desc";}else{_e.sort=_b.sort[0].attribute+"-asc";}}}else{_e.sort="date-posted-asc";}_c.push("sort:"+_e.sort);_c=_c.join(".");_d=_d.length>0?"."+_d.join("."):"";var _14=_c+_d;_8={query:_b,count:_8._curCount,start:_8._curStart,_realCount:_8._realCount,_realStart:_8._realStart,onBegin:_8.onBegin,onComplete:_8.onComplete,onItem:_8.onItem};var _15={request:_8,fetchHandler:_9,errorHandler:_a};if(this._handlers[_14]){this._handlers[_14].push(_15);return;}this._handlers[_14]=[_15];var _16=null;var _17={url:this._flickrRestUrl,preventCache:this.urlPreventCache,content:_e,callbackParamName:"jsoncallback"};var _18=_4.hitch(this,function(_19,_1a,_1b){var _1c=_1b.request.onBegin;_1b.request.onBegin=null;var _1d;var req=_1b.request;if(("_realStart" in req)&&req._realStart!=null){req.start=req._realStart;req.count=req._realCount;req._realStart=req._realCount=null;}if(_1c){var _1e=null;if(_1a){_1e=(_1a.photoset?_1a.photoset:_1a.photos);}if(_1e&&("perpage" in _1e)&&("pages" in _1e)){if(_1e.perpage*_1e.pages<=_1b.request.start+_1b.request.count){_1d=_1b.request.start+_1e.photo.length;}else{_1d=_1e.perpage*_1e.pages;}this._maxPhotosPerUser[_c]=_1d;_1c(_1d,_1b.request);}else{if(this._maxPhotosPerUser[_c]){_1c(this._maxPhotosPerUser[_c],_1b.request);}}}_1b.fetchHandler(_19,_1b.request);if(_1c){_1b.request.onBegin=_1c;}});var _1f=_4.hitch(this,function(_20){if(_20.stat!="ok"){_a(null,_8);}else{var _21=this._handlers[_14];if(!_21){console.log("FlickrRestStore: no handlers for data",_20);return;}this._handlers[_14]=null;this._prevRequests[_14]=_20;var _22=this._processFlickrData(_20,_8,_c);if(!this._prevRequestRanges[_c]){this._prevRequestRanges[_c]=[];}this._prevRequestRanges[_c].push({start:_8.start,end:_8.start+(_20.photoset?_20.photoset.photo.length:_20.photos.photo.length)});_4.forEach(_21,function(i){_18(_22,_20,i);});}});var _23=this._prevRequests[_14];if(_23){this._handlers[_14]=null;_18(this._cache[_c],_23,_15);return;}else{if(this._checkPrevRanges(_c,_8.start,_8.count)){this._handlers[_14]=null;_18(this._cache[_c],null,_15);return;}}var _24=_4.io.script.get(_17);_24.addCallback(_1f);_24.addErrback(function(_25){_4.disconnect(_16);_a(_25,_8);});},getAttributes:function(_26){return ["title","author","imageUrl","imageUrlSmall","imageUrlMedium","imageUrlThumb","imageUrlLarge","imageUrlOriginal","link","dateTaken","datePublished"];},getValues:function(_27,_28){this._assertIsItem(_27);this._assertIsAttribute(_28);switch(_28){case "title":return [this._unescapeHtml(_27.title)];case "author":return [_27.ownername];case "imageUrlSmall":return [_27.media.s];case "imageUrl":return [_27.media.l];case "imageUrlOriginal":return [_27.media.o];case "imageUrlLarge":return [_27.media.l];case "imageUrlMedium":return [_27.media.m];case "imageUrlThumb":return [_27.media.t];case "link":return ["http://www.flickr.com/photos/"+_27.owner+"/"+_27.id];case "dateTaken":return [_27.datetaken];case "datePublished":return [_27.datepublished];default:return undefined;}},_processFlickrData:function(_29,_2a,_2b){if(_29.items){return _6.data.FlickrStore.prototype._processFlickrData.apply(this,arguments);}var _2c=["http://farm",null,".static.flickr.com/",null,"/",null,"_",null];var _2d=[];var _2e=(_29.photoset?_29.photoset:_29.photos);if(_29.stat=="ok"&&_2e&&_2e.photo){_2d=_2e.photo;for(var i=0;i<_2d.length;i++){var _2f=_2d[i];_2f[this._storeRef]=this;_2c[1]=_2f.farm;_2c[3]=_2f.server;_2c[5]=_2f.id;_2c[7]=_2f.secret;var _30=_2c.join("");_2f.media={s:_30+"_s.jpg",m:_30+"_m.jpg",l:_30+".jpg",t:_30+"_t.jpg",o:_30+"_o.jpg"};if(!_2f.owner&&_29.photoset){_2f.owner=_29.photoset.owner;}}}var _31=_2a.start?_2a.start:0;var arr=this._cache[_2b];if(!arr){this._cache[_2b]=arr=[];}_4.forEach(_2d,function(i,idx){arr[idx+_31]=i;});return arr;},_checkPrevRanges:function(_32,_33,_34){var end=_33+_34;var arr=this._prevRequestRanges[_32];return (!!arr)&&_4.some(arr,function(_35){return ((_33>=_35.start)&&(end<=_35.end));});}});}}};});