/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo._xdResourceLoaded(function(_1,_2,_3){return {depends:[["provide","dijit.tree.dndSource"],["require","dijit.tree._dndSelector"],["require","dojo.dnd.Manager"]],defineResource:function(_4,_5,_6){if(!_4._hasResource["dijit.tree.dndSource"]){_4._hasResource["dijit.tree.dndSource"]=true;_4.provide("dijit.tree.dndSource");_4.require("dijit.tree._dndSelector");_4.require("dojo.dnd.Manager");_4.declare("dijit.tree.dndSource",_5.tree._dndSelector,{isSource:true,accept:["text","treeNode"],copyOnly:false,dragThreshold:5,betweenThreshold:0,constructor:function(_7,_8){if(!_8){_8={};}_4.mixin(this,_8);this.isSource=typeof _8.isSource=="undefined"?true:_8.isSource;var _9=_8.accept instanceof Array?_8.accept:["text","treeNode"];this.accept=null;if(_9.length){this.accept={};for(var i=0;i<_9.length;++i){this.accept[_9[i]]=1;}}this.isDragging=false;this.mouseDown=false;this.targetAnchor=null;this.targetBox=null;this.dropPosition="";this._lastX=0;this._lastY=0;this.sourceState="";if(this.isSource){_4.addClass(this.node,"dojoDndSource");}this.targetState="";if(this.accept){_4.addClass(this.node,"dojoDndTarget");}this.topics=[_4.subscribe("/dnd/source/over",this,"onDndSourceOver"),_4.subscribe("/dnd/start",this,"onDndStart"),_4.subscribe("/dnd/drop",this,"onDndDrop"),_4.subscribe("/dnd/cancel",this,"onDndCancel")];},checkAcceptance:function(_a,_b){return true;},copyState:function(_c){return this.copyOnly||_c;},destroy:function(){this.inherited("destroy",arguments);_4.forEach(this.topics,_4.unsubscribe);this.targetAnchor=null;},_onDragMouse:function(e){var m=_4.dnd.manager(),_d=this.targetAnchor,_e=this.current,_f=this.currentWidget,_10=this.dropPosition;var _11="Over";if(_e&&this.betweenThreshold>0){if(!this.targetBox||_d!=_e){this.targetBox=_4.position(_e,true);}if((e.pageY-this.targetBox.y)<=this.betweenThreshold){_11="Before";}else{if((e.pageY-this.targetBox.y)>=(this.targetBox.h-this.betweenThreshold)){_11="After";}}}if(_e!=_d||_11!=_10){if(_d){this._removeItemClass(_d,_10);}if(_e){this._addItemClass(_e,_11);}if(!_e){m.canDrop(false);}else{if(_f==this.tree.rootNode&&_11!="Over"){m.canDrop(false);}else{if(m.source==this&&(_e.id in this.selection)){m.canDrop(false);}else{if(this.checkItemAcceptance(_e,m.source,_11.toLowerCase())&&!this._isParentChildDrop(m.source,_e)){m.canDrop(true);}else{m.canDrop(false);}}}}this.targetAnchor=_e;this.dropPosition=_11;}},onMouseMove:function(e){if(this.isDragging&&this.targetState=="Disabled"){return;}this.inherited(arguments);var m=_4.dnd.manager();if(this.isDragging){this._onDragMouse(e);}else{if(this.mouseDown&&this.isSource&&(Math.abs(e.pageX-this._lastX)>=this.dragThreshold||Math.abs(e.pageY-this._lastY)>=this.dragThreshold)){var n=this.getSelectedNodes();var _12=[];for(var i in n){_12.push(n[i]);}if(_12.length){m.startDrag(this,_12,this.copyState(_4.isCopyKey(e)));}}}},onMouseDown:function(e){this.mouseDown=true;this.mouseButton=e.button;this._lastX=e.pageX;this._lastY=e.pageY;this.inherited("onMouseDown",arguments);},onMouseUp:function(e){if(this.mouseDown){this.mouseDown=false;this.inherited("onMouseUp",arguments);}},onMouseOut:function(){this.inherited(arguments);this._unmarkTargetAnchor();},checkItemAcceptance:function(_13,_14,_15){return true;},onDndSourceOver:function(_16){if(this!=_16){this.mouseDown=false;this._unmarkTargetAnchor();}else{if(this.isDragging){var m=_4.dnd.manager();m.canDrop(false);}}},onDndStart:function(_17,_18,_19){if(this.isSource){this._changeState("Source",this==_17?(_19?"Copied":"Moved"):"");}var _1a=this.checkAcceptance(_17,_18);this._changeState("Target",_1a?"":"Disabled");if(this==_17){_4.dnd.manager().overSource(this);}this.isDragging=true;},itemCreator:function(_1b,_1c,_1d){return _4.map(_1b,function(_1e){return {"id":_1e.id,"name":_1e.textContent||_1e.innerText||""};});},onDndDrop:function(_1f,_20,_21){if(this.containerState=="Over"){var _22=this.tree,_23=_22.model,_24=this.targetAnchor,_25=false;this.isDragging=false;var _26=_5.getEnclosingWidget(_24);var _27;var _28;_27=(_26&&_26.item)||_22.item;if(this.dropPosition=="Before"||this.dropPosition=="After"){_27=(_26.getParent()&&_26.getParent().item)||_22.item;_28=_26.getIndexInParent();if(this.dropPosition=="After"){_28=_26.getIndexInParent()+1;}}else{_27=(_26&&_26.item)||_22.item;}var _29;_4.forEach(_20,function(_2a,idx){var _2b=_1f.getItem(_2a.id);if(_4.indexOf(_2b.type,"treeNode")!=-1){var _2c=_2b.data,_2d=_2c.item,_2e=_2c.getParent().item;}if(_1f==this){if(typeof _28=="number"){if(_27==_2e&&_2c.getIndexInParent()<_28){_28-=1;}}_23.pasteItem(_2d,_2e,_27,_21,_28);}else{if(_23.isItem(_2d)){_23.pasteItem(_2d,_2e,_27,_21,_28);}else{if(!_29){_29=this.itemCreator(_20,_24,_1f);}_23.newItem(_29[idx],_27,_28);}}},this);this.tree._expandNode(_26);}this.onDndCancel();},onDndCancel:function(){this._unmarkTargetAnchor();this.isDragging=false;this.mouseDown=false;delete this.mouseButton;this._changeState("Source","");this._changeState("Target","");},onOverEvent:function(){this.inherited(arguments);_4.dnd.manager().overSource(this);},onOutEvent:function(){this._unmarkTargetAnchor();var m=_4.dnd.manager();if(this.isDragging){m.canDrop(false);}m.outSource(this);this.inherited(arguments);},_isParentChildDrop:function(_2f,_30){if(!_2f.tree||_2f.tree!=this.tree){return false;}var _31=_2f.tree.domNode;var ids={};for(var x in _2f.selection){ids[_2f.selection[x].parentNode.id]=true;}var _32=_30.parentNode;while(_32!=_31&&(!_32.id||!ids[_32.id])){_32=_32.parentNode;}return _32.id&&ids[_32.id];},_unmarkTargetAnchor:function(){if(!this.targetAnchor){return;}this._removeItemClass(this.targetAnchor,this.dropPosition);this.targetAnchor=null;this.targetBox=null;this.dropPosition=null;},_markDndStatus:function(_33){this._changeState("Source",_33?"Copied":"Moved");}});}}};});