/*
	Copyright (c) 2004-2009, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["dijit._editor.plugins.ViewSource"]){dojo._hasResource["dijit._editor.plugins.ViewSource"]=true;dojo.provide("dijit._editor.plugins.ViewSource");dojo.require("dijit._editor._Plugin");dojo.require("dijit.form.Button");dojo.require("dojo.i18n");dojo.requireLocalization("dijit._editor","commands",null,"ROOT,ar,ca,cs,da,de,el,es,fi,fr,he,hu,it,ja,ko,nb,nl,pl,pt,pt-pt,ru,sk,sl,sv,th,tr,zh,zh-tw");dojo.declare("dijit._editor.plugins.ViewSource",dijit._editor._Plugin,{stripScripts:true,stripComments:true,stripIFrames:true,readOnly:false,_fsPlugin:null,toggle:function(){if(dojo.isWebKit){this._vsFocused=true;}this.button.attr("checked",!this.button.attr("checked"));},_initButton:function(){var _1=dojo.i18n.getLocalization("dijit._editor","commands");this.button=new dijit.form.ToggleButton({label:_1["viewSource"],showLabel:false,iconClass:this.iconClassPrefix+" "+this.iconClassPrefix+"ViewSource",tabIndex:"-1",onChange:dojo.hitch(this,"_showSource")});if(dojo.isIE==7){this._ieFixNode=dojo.create("div",{style:{opacity:"0",zIndex:"-1000",position:"absolute",top:"-1000px"}},dojo.body());}this.button.attr("readOnly",false);},setEditor:function(_2){this.editor=_2;this._initButton();this.editor.addKeyHandler(dojo.keys.F12,true,true,dojo.hitch(this,function(e){this.button.focus();this.toggle();dojo.stopEvent(e);setTimeout(dojo.hitch(this,function(){this.editor.focus();}),100);}));},_showSource:function(_3){var ed=this.editor;var _4=ed._plugins;var _5;this._sourceShown=_3;var _6=this;try{if(!this.sourceArea){this._createSourceView();}if(_3){ed._sourceQueryCommandEnabled=ed.queryCommandEnabled;ed.queryCommandEnabled=function(_7){var _8=_7.toLowerCase();if(_8==="viewsource"){return true;}else{return false;}};this.editor.onDisplayChanged();_5=ed.attr("value");_5=this._filter(_5);ed.attr("value",_5);this._pluginList=[];this._disabledPlugins=dojo.filter(_4,function(p){if(p&&p.button&&!p.button.attr("disabled")&&!(p instanceof dijit._editor.plugins.ViewSource)){p._vs_updateState=p.updateState;p.updateState=function(){return false;};p.button.attr("disabled",true);if(p.command){switch(p.command){case "bold":case "italic":case "underline":case "strikethrough":case "superscript":case "subscript":p.button.attr("checked",false);break;default:break;}}return true;}});if(this._fsPlugin){this._fsPlugin._getAltViewNode=function(){return _6.sourceArea;};}this.sourceArea.value=_5;var is=dojo.marginBox(ed.iframe.parentNode);dojo.marginBox(this.sourceArea,{w:is.w,h:is.h});dojo.style(ed.iframe,"display","none");dojo.style(this.sourceArea,{display:"block"});var _9=function(){var vp=dijit.getViewport();if("_prevW" in this&&"_prevH" in this){if(vp.w===this._prevW&&vp.h===this._prevH){return;}else{this._prevW=vp.w;this._prevH=vp.h;}}else{this._prevW=vp.w;this._prevH=vp.h;}if(this._resizer){clearTimeout(this._resizer);delete this._resizer;}this._resizer=setTimeout(dojo.hitch(this,function(){delete this._resizer;this._resize();}),10);};this._resizeHandle=dojo.connect(window,"onresize",this,_9);setTimeout(dojo.hitch(this,this._resize),100);this.editor.onNormalizedDisplayChanged();}else{if(!ed._sourceQueryCommandEnabled){return;}dojo.disconnect(this._resizeHandle);delete this._resizeHandle;ed.queryCommandEnabled=ed._sourceQueryCommandEnabled;if(!this._readOnly){_5=this.sourceArea.value;_5=this._filter(_5);ed.attr("value",_5);}dojo.forEach(this._disabledPlugins,function(p){p.button.attr("disabled",false);if(p._vs_updateState){p.updateState=p._vs_updateState;}});this._disabledPlugins=null;dojo.style(this.sourceArea,"display","none");dojo.style(ed.iframe,"display","block");delete ed._sourceQueryCommandEnabled;this.editor.onDisplayChanged();}setTimeout(dojo.hitch(this,function(){var _a=ed.domNode.parentNode;if(_a){var _b=dijit.getEnclosingWidget(_a);if(_b&&_b.resize){_b.resize();}}ed.resize();}),300);}catch(e){console.log(e);}},_resize:function(){var ed=this.editor;var _c=ed.getHeaderHeight();var fH=ed.getFooterHeight();var eb=dojo.position(ed.domNode);var _d=dojo._getPadBorderExtents(ed.iframe.parentNode);var _e=dojo._getMarginExtents(ed.iframe.parentNode);var _f=dojo._getPadBorderExtents(ed.domNode);var _10=dojo._getMarginExtents(ed.domNode);var edb={w:eb.w-(_f.w+_10.w),h:eb.h-(_c+_f.h+_10.h+fH)};if(this._fsPlugin&&this._fsPlugin.isFullscreen){var vp=dijit.getViewport();edb.w=(vp.w-_f.w);edb.h=(vp.h-(_c+_f.h+fH));}if(dojo.isIE){edb.h-=2;}if(this._ieFixNode){var _11=-this._ieFixNode.offsetTop/1000;edb.w=Math.floor((edb.w+0.9)/_11);edb.h=Math.floor((edb.h+0.9)/_11);}dojo.marginBox(this.sourceArea,{w:edb.w-(_d.w+_e.w),h:edb.h-(_d.h+_e.h)});dojo.marginBox(ed.iframe.parentNode,{h:edb.h});},_createSourceView:function(){var ed=this.editor;var _12=ed._plugins;this.sourceArea=dojo.create("textarea");if(this.readOnly){dojo.attr(this.sourceArea,"readOnly",true);this._readOnly=true;}dojo.style(this.sourceArea,{padding:"0px",margin:"0px",borderWidth:"0px",borderStyle:"none"});dojo.place(this.sourceArea,ed.iframe,"before");if(dojo.isIE&&ed.iframe.parentNode.lastChild!==ed.iframe){dojo.style(ed.iframe.parentNode.lastChild,{width:"0px",height:"0px",padding:"0px",margin:"0px",borderWidth:"0px",borderStyle:"none"});}ed._viewsource_oldFocus=ed.focus;var _13=this;ed.focus=function(){if(_13._sourceShown){_13.setSourceAreaCaret();}else{try{if(this._vsFocused){delete this._vsFocused;dijit.focus(ed.editNode);}else{ed._viewsource_oldFocus();}}catch(e){console.log(e);}}};var i,p;for(i=0;i<_12.length;i++){p=_12[i];if(p&&(p.declaredClass==="dijit._editor.plugins.FullScreen"||p.declaredClass===(dijit._scopeName+"._editor.plugins.FullScreen"))){this._fsPlugin=p;break;}}if(this._fsPlugin){this._fsPlugin._viewsource_getAltViewNode=this._fsPlugin._getAltViewNode;this._fsPlugin._getAltViewNode=function(){return _13._sourceShown?_13.sourceArea:this._viewsource_getAltViewNode();};}this.connect(this.sourceArea,"onkeydown",dojo.hitch(this,function(e){if(this._sourceShown&&e.keyCode==dojo.keys.F12&&e.ctrlKey&&e.shiftKey){this.button.focus();this.button.attr("checked",false);setTimeout(dojo.hitch(this,function(){ed.focus();}),100);dojo.stopEvent(e);}}));},_stripScripts:function(_14){if(_14){_14=_14.replace(/<\s*script[^>]*>((.|\s)*?)<\\?\/\s*script\s*>/ig,"");_14=_14.replace(/<\s*script\b([^<>]|\s)*>?/ig,"");_14=_14.replace(/<[^>]*=(\s|)*[("|')]javascript:[^$1][(\s|.)]*[$1][^>]*>/ig,"");}return _14;},_stripComments:function(_15){if(_15){_15=_15.replace(/<!--(.|\s){1,}?-->/g,"");}return _15;},_stripIFrames:function(_16){if(_16){_16=_16.replace(/<\s*iframe[^>]*>((.|\s)*?)<\\?\/\s*iframe\s*>/ig,"");}return _16;},_filter:function(_17){if(_17){if(this.stripScripts){_17=this._stripScripts(_17);}if(this.stripComments){_17=this._stripComments(_17);}if(this.stripIFrames){_17=this._stripIFrames(_17);}}return _17;},setSourceAreaCaret:function(){var win=dojo.global;var _18=this.sourceArea;dijit.focus(_18);if(this._sourceShown&&!this.readOnly){if(dojo.isIE){if(this.sourceArea.createTextRange){var _19=_18.createTextRange();_19.collapse(true);_19.moveStart("character",-99999);_19.moveStart("character",0);_19.moveEnd("character",0);_19.select();}}else{if(win.getSelection){if(_18.setSelectionRange){_18.setSelectionRange(0,0);}}}}},destroy:function(){if(this._ieFixNode){dojo.body().removeChild(this._ieFixNode);}if(this._resizer){clearTimeout(this._resizer);delete this._resizer;}if(this._resizeHandle){dojo.disconnect(this._resizeHandle);delete this._resizeHandle;}this.inherited(arguments);}});dojo.subscribe(dijit._scopeName+".Editor.getPlugin",null,function(o){if(o.plugin){return;}var _1a=o.args.name.toLowerCase();if(_1a==="viewsource"){o.plugin=new dijit._editor.plugins.ViewSource({readOnly:("readOnly" in o.args)?o.args.readOnly:false,stripComments:("stripComments" in o.args)?o.args.stripComments:true,stripScripts:("stripScripts" in o.args)?o.args.stripScripts:true,stripIFrames:("stripIFrames" in o.args)?o.args.stripIFrames:true});}});}